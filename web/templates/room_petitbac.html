<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Room.Name}} - Petit Bac Musical</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/icons.css">
    <style>
        .hidden { display: none !important; }
        
        .player-item.submitted { border-left: 3px solid var(--success); }
        .player-item.ready { border-left: 3px solid var(--success); }
        
        #scoreList { list-style: none; counter-reset: ranking; }
        #scoreList li {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 12px; border-radius: 8px; margin-bottom: 4px;
            counter-increment: ranking;
        }
        #scoreList li::before {
            content: counter(ranking); width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            font-size: 0.75rem; font-weight: 600;
        }
        #scoreList li:first-child::before { background: var(--warning); color: black; }
        #scoreList li:nth-child(2)::before { background: #9CA3AF; color: black; }
        #scoreList li:nth-child(3)::before { background: #CD7F32; color: black; }
        
        .vote-item { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .vote-answer { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-top: 8px; }
        .vote-buttons { display: flex; gap: 8px; }
        .vote-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .vote-btn.accept { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .vote-btn.accept:hover, .vote-btn.accept.active { background: var(--success); color: white; }
        .vote-btn.reject { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .vote-btn.reject:hover, .vote-btn.reject.active { background: var(--danger); color: white; }
        
        .category-item input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .category-item input.valid { border-color: var(--success); }
        .category-item input.invalid { border-color: var(--danger); }
        
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        #currentLetter { animation: pulse 2s ease-in-out infinite; }
        
        .connection-status { position: fixed; top: 80px; right: 20px; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; z-index: 100; display: flex; align-items: center; gap: 0.5rem; }
        .connection-status.connected { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--success); color: var(--success); }
        .connection-status.disconnected { background: rgba(255, 107, 107, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .connection-status.connecting { background: rgba(255, 165, 0, 0.1); border: 1px solid var(--warning); color: var(--warning); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .status-dot.pulsing { animation: statusPulse 1s ease-in-out infinite; }
        @keyframes statusPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        #timer.warning { color: var(--warning) !important; }
        #timer.danger { color: var(--danger) !important; animation: pulse 0.5s ease-in-out infinite; }
        
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; animation: slideIn 0.3s ease-out; }
        .toast-success { background: rgba(16, 185, 129, 0.9); color: white; }
        .toast-error { background: rgba(239, 68, 68, 0.9); color: white; }
        .toast-warning { background: rgba(245, 158, 11, 0.9); color: white; }
        .toast-info { background: rgba(99, 102, 241, 0.9); color: white; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand"><span class="icon icon-music icon-md"></span><span>Groupie Tracker</span></a>
        <ul class="navbar-nav"><li><a href="/">Accueil</a></li><li><a href="/rooms">Salles</a></li></ul>
        <div class="navbar-user">
            <div class="user-info"><div class="avatar">{{slice .User.Pseudo 0 1}}</div><span>{{.User.Pseudo}}</span></div>
            <a href="/logout" class="btn btn-secondary btn-sm">D√©connexion</a>
        </div>
    </nav>

    <div id="connection-status" class="connection-status connecting">
        <span class="status-dot pulsing"></span><span id="connection-text">Connexion...</span>
    </div>

    <div class="container">
        <header class="room-header" style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2rem;">
            <div>
                <h1 style="display: flex; align-items: center; gap: 12px;"><span class="icon icon-letters icon-lg"></span>{{.Room.Name}}</h1>
                <div style="display: flex; gap: 16px; margin-top: 8px; align-items: center;">
                    <span class="badge badge-secondary"><span class="icon icon-letters icon-xs"></span>Petit Bac Musical</span>
                    <div class="room-code-display" style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; font-family: var(--font-mono);">
                        <span class="icon icon-key icon-sm"></span><span id="roomCode">{{.Room.Code}}</span>
                        <button class="btn btn-ghost btn-sm" onclick="copyCode()" title="Copier"><span class="icon icon-copy icon-xs"></span></button>
                    </div>
                </div>
            </div>
            <a href="/rooms" class="btn btn-ghost" onclick="leaveRoom(event)"><span class="icon icon-arrow-left icon-sm"></span><span>Quitter</span></a>
        </header>

        <div class="room-layout" style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
            <div class="game-area">
                <!-- √âtat: En attente -->
                <div id="waiting-state" class="game-state {{if ne .Room.Status "waiting"}}hidden{{end}}">
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">‚è≥</div>
                        <h2>En attente des joueurs</h2>
                        <p class="text-muted" style="margin: 1rem 0;">Partagez le code <strong style="font-family: var(--font-mono); color: var(--primary);">{{.Room.Code}}</strong></p>
                        <div style="text-align: left; background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; margin: 2rem 0;">
                            <h4 style="margin-bottom: 1rem;">üìñ R√®gles</h4>
                            <ul style="list-style: none; color: var(--text-secondary);">
                                <li style="padding: 8px 0;">üî§ Une lettre al√©atoire par manche</li>
                                <li style="padding: 8px 0;">üéµ 5 cat√©gories musicales</li>
                                <li style="padding: 8px 0;">‚è±Ô∏è 60 secondes par manche</li>
                                <li style="padding: 8px 0;">üëç Validation par vote</li>
                            </ul>
                        </div>
                        {{if .Player.IsHost}}
                        <button id="startBtn" class="btn btn-success btn-lg" onclick="startGame()" disabled style="margin-top: 1rem;"><span class="icon icon-play icon-sm"></span><span>Lancer</span></button>
                        <p class="text-muted" id="startHint" style="font-size: 0.875rem; margin-top: 0.5rem;">Mode solo disponible</p>
                        {{else}}
                        <button id="readyBtn" class="btn btn-primary btn-lg" onclick="toggleReady()" style="margin-top: 1rem;"><span class="icon icon-check icon-sm"></span><span id="readyBtnText">Je suis pr√™t</span></button>
                        {{end}}
                    </div>
                </div>

                <!-- √âtat: En jeu -->
                <div id="playing-state" class="game-state {{if ne .Room.Status "playing"}}hidden{{end}}">
                    <div class="round-info card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
                        <div><span class="text-muted">Manche</span><strong id="currentRound" style="font-size: 1.5rem; margin-left: 8px;">1</strong><span class="text-muted">/ <span id="totalRounds">9</span></span></div>
                        <div id="timer" style="font-size: 2rem; font-family: var(--font-mono); color: var(--primary);">1:00</div>
                    </div>

                    <div class="card" style="text-align: center; padding: 2rem; margin-bottom: 1.5rem;">
                        <p class="text-muted" style="margin-bottom: 0.5rem;">La lettre est...</p>
                        <div id="currentLetter" style="font-size: 6rem; font-weight: 700; color: var(--primary); text-shadow: 0 0 40px rgba(99, 102, 241, 0.5);">?</div>
                    </div>

                    <div id="answersPhase" class="card" style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem;"><span class="icon icon-edit icon-sm"></span> Vos r√©ponses</h3>
                        <form id="answersForm" onsubmit="submitAnswers(event)">
                            <div class="categories-grid" style="display: grid; gap: 1rem;">
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="font-weight: 500;">üé§ Artiste</label>
                                    <input type="text" name="artiste" class="form-control" placeholder="Ex: Adele..." autocomplete="off">
                                </div>
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="font-weight: 500;">üíø Album</label>
                                    <input type="text" name="album" class="form-control" placeholder="Ex: Abbey Road..." autocomplete="off">
                                </div>
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="font-weight: 500;">üë• Groupe</label>
                                    <input type="text" name="groupe" class="form-control" placeholder="Ex: Guns N' Roses..." autocomplete="off">
                                </div>
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="font-weight: 500;">üé∏ Instrument</label>
                                    <input type="text" name="instrument" class="form-control" placeholder="Ex: Accord√©on..." autocomplete="off">
                                </div>
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="font-weight: 500;">üéµ Featuring</label>
                                    <input type="text" name="featuring" class="form-control" placeholder="Ex: feat. Drake..." autocomplete="off">
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitAnswersBtn" style="flex: 1;"><span class="icon icon-check icon-sm"></span><span>Valider</span></button>
                                <button type="button" class="btn btn-danger btn-lg" id="stopBtn" onclick="stopRound()"><span class="icon icon-stop icon-sm"></span><span>STOP!</span></button>
                            </div>
                        </form>
                        <div id="submittedMessage" class="hidden" style="text-align: center; padding: 2rem; color: var(--success);">‚úì R√©ponses envoy√©es !</div>
                    </div>

                    <div id="votingPhase" class="card hidden" style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0;">üó≥Ô∏è Validation</h3>
                            <div id="voteTimer" style="font-size: 1.5rem; font-family: var(--font-mono); color: var(--primary);">0:30</div>
                        </div>
                        <div id="votingCategories"></div>
                        <button id="submitVotesBtn" class="btn btn-primary btn-lg btn-block" onclick="submitVotes()" style="margin-top: 1.5rem;"><span class="icon icon-check icon-sm"></span><span>Valider</span></button>
                    </div>

                    <div id="roundResult" class="card hidden" style="padding: 2rem; margin-top: 1.5rem;">
                        <h3 style="text-align: center; margin-bottom: 1.5rem;">üìä R√©sultats</h3>
                        <div id="roundScores"></div>
                        <p id="nextRoundInfo" class="text-muted" style="text-align: center; margin-top: 1rem;"></p>
                    </div>
                </div>

                <!-- √âtat: Termin√© -->
                <div id="finished-state" class="game-state {{if ne .Room.Status "finished"}}hidden{{end}}">
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèÜ</div>
                        <h2>Partie termin√©e !</h2>
                        <div id="winner" style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); border-radius: 12px;">
                            <p class="text-muted">Vainqueur</p>
                            <h3 id="winnerName" style="font-size: 2rem; color: var(--warning);">-</h3>
                            <p id="winnerScore" style="font-size: 1.25rem;">0 points</p>
                        </div>
                        <div id="finalRanking" style="text-align: left; margin: 2rem 0;"></div>
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                            {{if .Player.IsHost}}<button class="btn btn-primary btn-lg" onclick="restartGame()"><span class="icon icon-refresh icon-sm"></span><span>Rejouer</span></button>{{end}}
                            <a href="/rooms" class="btn btn-secondary btn-lg"><span class="icon icon-arrow-left icon-sm"></span><span>Retour</span></a>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="card" style="padding: 1.5rem;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">üë• Joueurs <span class="badge badge-secondary" style="margin-left: auto;"><span id="playerCount">{{len .Room.Players}}</span>/8</span></h3>
                    <ul id="playersList" style="list-style: none;">
                        {{range $id, $player := .Room.Players}}
                        <li class="player-item {{if $player.IsReady}}ready{{end}}" data-user-id="{{$id}}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                            <div class="avatar" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">{{if $player.IsHost}}üëë{{else}}{{slice $player.Pseudo 0 1}}{{end}}</div>
                            <div style="flex: 1;"><div style="font-weight: 500;">{{$player.Pseudo}}</div><div class="player-status text-muted" style="font-size: 0.75rem;">{{if $player.IsReady}}<span style="color: var(--success);">‚úì Pr√™t</span>{{else}}<span>En attente</span>{{end}}</div></div>
                            <div class="player-score" style="font-family: var(--font-mono); font-weight: 600; color: var(--primary);">{{$player.Score}}</div>
                        </li>
                        {{end}}
                    </ul>
                </div>
                <div id="scoreboard" class="card {{if eq .Room.Status "waiting"}}hidden{{end}}" style="padding: 1.5rem; margin-top: 1rem;">
                    <h3 style="margin-bottom: 1rem;">üèÜ Classement</h3>
                    <ol id="scoreList"></ol>
                </div>
            </aside>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
    const CONFIG = { 
        WS_RECONNECT_DELAY: 1000, 
        WS_MAX_RECONNECT_ATTEMPTS: 10, 
        TOAST_DURATION: 3000
    };
    
    const roomCode = '{{.Room.Code}}';
    const roomId = '{{.Room.ID}}';
    const userId = '{{.User.ID}}';
    const isHost = '{{.Player.IsHost}}' === 'true';
    
    let ws = null;
    let wsConnected = false;
    let wsReconnectAttempts = 0;
    let wsReconnectTimer = null;
    let isReady = false;
    let currentVotes = {};
    let currentLetter = '';
    let hasSubmittedAnswers = false;
    let hasSubmittedVotes = false;
    let currentPhase = 'waiting'; // waiting, answering, voting, results
    let DOM = {};

    function debug(...args) {
        console.log('[PetitBac]', ...args);
    }

    function initDOM() {
        DOM = {
            connectionStatus: document.getElementById('connection-status'),
            connectionText: document.getElementById('connection-text'),
            waitingState: document.getElementById('waiting-state'),
            playingState: document.getElementById('playing-state'),
            finishedState: document.getElementById('finished-state'),
            currentRound: document.getElementById('currentRound'),
            totalRounds: document.getElementById('totalRounds'),
            currentLetter: document.getElementById('currentLetter'),
            timer: document.getElementById('timer'),
            voteTimer: document.getElementById('voteTimer'),
            answersForm: document.getElementById('answersForm'),
            answersPhase: document.getElementById('answersPhase'),
            votingPhase: document.getElementById('votingPhase'),
            votingCategories: document.getElementById('votingCategories'),
            submittedMessage: document.getElementById('submittedMessage'),
            roundResult: document.getElementById('roundResult'),
            roundScores: document.getElementById('roundScores'),
            nextRoundInfo: document.getElementById('nextRoundInfo'),
            startBtn: document.getElementById('startBtn'),
            startHint: document.getElementById('startHint'),
            readyBtn: document.getElementById('readyBtn'),
            readyBtnText: document.getElementById('readyBtnText'),
            submitAnswersBtn: document.getElementById('submitAnswersBtn'),
            submitVotesBtn: document.getElementById('submitVotesBtn'),
            stopBtn: document.getElementById('stopBtn'),
            playersList: document.getElementById('playersList'),
            playerCount: document.getElementById('playerCount'),
            scoreboard: document.getElementById('scoreboard'),
            scoreList: document.getElementById('scoreList'),
            winnerName: document.getElementById('winnerName'),
            winnerScore: document.getElementById('winnerScore'),
            finalRanking: document.getElementById('finalRanking')
        };
    }

    function showToast(msg, type = 'info', duration = CONFIG.TOAST_DURATION) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            container.id = 'toastContainer';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<span>${msg}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    function updateConnectionStatus(status) {
        if (!DOM.connectionStatus) return;
        DOM.connectionStatus.className = `connection-status ${status}`;
        const dot = DOM.connectionStatus.querySelector('.status-dot');
        DOM.connectionText.textContent = status === 'connected' ? 'Connect√©' : status === 'disconnected' ? 'D√©connect√©' : 'Connexion...';
        if (dot) dot.classList.toggle('pulsing', status !== 'connected');
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        
        updateConnectionStatus('connecting');
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${location.host}/ws/room/${roomCode}`;
        
        debug('Connexion WS √†', wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                debug('‚úÖ WebSocket connect√©');
                wsConnected = true;
                wsReconnectAttempts = 0;
                updateConnectionStatus('connected');
                showToast('Connect√©', 'success');
            };
            
            ws.onclose = (event) => {
                debug('‚ùå WebSocket ferm√©', event.code);
                wsConnected = false;
                updateConnectionStatus('disconnected');
                if (!event.wasClean && wsReconnectAttempts < CONFIG.WS_MAX_RECONNECT_ATTEMPTS) {
                    scheduleReconnect();
                }
            };
            
            ws.onerror = () => updateConnectionStatus('disconnected');
            
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    debug('üì®', msg.type, msg.payload);
                    handleMessage(msg);
                } catch (err) {
                    debug('‚ùå Parse error:', err.message, 'Data:', event.data.substring(0, 100));
                }
            };
        } catch (e) {
            debug('‚ùå WS error:', e);
            scheduleReconnect();
        }
    }

    function scheduleReconnect() {
        if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
        wsReconnectAttempts++;
        const delay = Math.min(CONFIG.WS_RECONNECT_DELAY * wsReconnectAttempts, 10000);
        updateConnectionStatus('connecting');
        wsReconnectTimer = setTimeout(connectWebSocket, delay);
    }

    function sendWS(type, payload = {}) {
        if (!wsConnected || !ws || ws.readyState !== WebSocket.OPEN) return false;
        debug('üì§', type, payload);
        ws.send(JSON.stringify({ type, payload }));
        return true;
    }

    function handleMessage(msg) {
        const type = msg.type;
        const payload = msg.payload || {};
        
        switch(type) {
            case 'player_joined':
                showToast(`${payload.pseudo} a rejoint`, 'info');
                setTimeout(() => location.reload(), 500);
                break;
                
            case 'player_left':
                showToast(`${payload.pseudo} a quitt√©`, 'warning');
                document.querySelector(`[data-user-id="${payload.user_id}"]`)?.remove();
                updateStartButton();
                break;
                
            case 'player_ready':
                handlePlayerReady(payload);
                break;
                
            case 'room_update':
                if (payload.status) updateGameState(payload.status);
                break;
                
            case 'game_start':
            case 'start_game':
                debug('üéÆ GAME START');
                showToast('Partie lanc√©e !', 'success');
                DOM.waitingState.classList.add('hidden');
                DOM.playingState.classList.remove('hidden');
                DOM.scoreboard.classList.remove('hidden');
                break;
                
            case 'new_round':
                debug('üìù NEW ROUND', payload);
                handleNewRound(payload);
                break;
                
            case 'time_update':
                handleTimeUpdate(payload);
                break;
                
            case 'player_submitted':
                document.querySelector(`[data-user-id="${payload.user_id}"]`)?.classList.add('submitted');
                showToast(`${payload.pseudo} a termin√©`, 'info');
                break;
                
            case 'round_stop':
                showToast(`${payload.stopped_by} a appuy√© sur STOP!`, 'warning');
                if (DOM.timer) {
                    DOM.timer.textContent = 'STOP!';
                    DOM.timer.className = 'danger';
                }
                if (!hasSubmittedAnswers) submitAnswers(new Event('submit'));
                break;
                
            case 'voting_start':
                debug('üó≥Ô∏è VOTING START');
                handleVotingStart(payload);
                break;
                
            case 'vote_time_update':
                if (DOM.voteTimer && currentPhase === 'voting') {
                    DOM.voteTimer.textContent = formatTime(payload.time_left);
                    DOM.voteTimer.className = payload.time_left <= 5 ? 'danger' : payload.time_left <= 10 ? 'warning' : '';
                }
                break;
                
            case 'round_result':
                debug('üìä ROUND RESULT');
                handleRoundResult(payload);
                break;
                
            case 'game_end':
                debug('üèÜ GAME END');
                handleGameEnd(payload);
                break;
                
            case 'answers_submitted':
                showToast('R√©ponses envoy√©es', 'success');
                break;
                
            case 'votes_submitted':
                showToast('Votes envoy√©s', 'success');
                break;
                
            case 'error':
                showToast(payload.message || msg.error || 'Erreur', 'error');
                break;
                
            case 'pong':
                break;
                
            default:
                debug('‚ö†Ô∏è Message non g√©r√©:', type);
        }
    }

    function handlePlayerReady(data) {
        const item = document.querySelector(`[data-user-id="${data.user_id}"]`);
        if (item) {
            const statusEl = item.querySelector('.player-status');
            if (statusEl) {
                statusEl.innerHTML = data.ready 
                    ? '<span style="color:var(--success)">‚úì Pr√™t</span>' 
                    : '<span>En attente</span>';
            }
            item.classList.toggle('ready', data.ready);
        }
        updateStartButton();
    }

    function handleNewRound(data) {
        debug('handleNewRound called with:', data);
        
        // IMPORTANT: Changer la phase AVANT tout
        currentPhase = 'answering';
        
        // Extraire les donn√©es
        const letter = data.letter || data.Letter || '?';
        const round = data.round || data.Round || 1;
        const total = data.total || data.Total || 9;
        const duration = data.duration || data.Duration || 60;
        
        currentLetter = letter;
        hasSubmittedAnswers = false;
        hasSubmittedVotes = false;
        
        // Mettre √† jour l'affichage
        if (DOM.currentRound) DOM.currentRound.textContent = round;
        if (DOM.totalRounds) DOM.totalRounds.textContent = total;
        if (DOM.currentLetter) DOM.currentLetter.textContent = letter;
        if (DOM.timer) {
            DOM.timer.textContent = formatTime(duration);
            DOM.timer.className = '';
        }
        
        // IMPORTANT: Cacher toutes les autres phases et afficher answersPhase
        if (DOM.votingPhase) DOM.votingPhase.classList.add('hidden');
        if (DOM.roundResult) DOM.roundResult.classList.add('hidden');
        if (DOM.answersPhase) DOM.answersPhase.classList.remove('hidden');
        if (DOM.submittedMessage) DOM.submittedMessage.classList.add('hidden');
        if (DOM.answersForm) {
            DOM.answersForm.reset();
            DOM.answersForm.classList.remove('hidden');
        }
        if (DOM.submitAnswersBtn) DOM.submitAnswersBtn.disabled = false;
        if (DOM.stopBtn) DOM.stopBtn.disabled = false;
        
        // R√©initialiser les inputs
        document.querySelectorAll('.category-item input').forEach(input => {
            input.classList.remove('valid', 'invalid');
            input.disabled = false;
        });
        
        // R√©initialiser les joueurs
        document.querySelectorAll('.player-item').forEach(item => item.classList.remove('submitted'));
        
        // Focus
        setTimeout(() => document.querySelector('input[name="artiste"]')?.focus(), 100);
        
        setupInputValidation();
        showToast(`Manche ${round} - Lettre ${letter}`, 'info');
    }

    function handleTimeUpdate(data) {
        // Ne mettre √† jour que si on est en phase de r√©ponse
        if (currentPhase === 'answering' && DOM.timer) {
            DOM.timer.textContent = formatTime(data.time_left);
            DOM.timer.className = data.time_left <= 5 ? 'danger' : data.time_left <= 15 ? 'warning' : '';
        }
    }

    function handleVotingStart(data) {
        currentPhase = 'voting';
        hasSubmittedVotes = false;
        currentVotes = {};
        
        // IMPORTANT: Cacher answers, afficher voting
        if (DOM.answersPhase) DOM.answersPhase.classList.add('hidden');
        if (DOM.roundResult) DOM.roundResult.classList.add('hidden');
        if (DOM.votingPhase) DOM.votingPhase.classList.remove('hidden');
        
        if (DOM.voteTimer) {
            DOM.voteTimer.textContent = formatTime(data.duration || 30);
            DOM.voteTimer.className = '';
        }
        if (DOM.submitVotesBtn) {
            DOM.submitVotesBtn.disabled = false;
            DOM.submitVotesBtn.innerHTML = '<span class="icon icon-check icon-sm"></span><span>Valider</span>';
        }
        
        buildVotingUI(data.answers || [], data.categories);
    }

    function buildVotingUI(answers, categories) {
        if (!DOM.votingCategories) return;
        
        DOM.votingCategories.innerHTML = '';
        const labels = {
            artiste: 'üé§ Artiste',
            album: 'üíø Album',
            groupe: 'üë• Groupe',
            instrument: 'üé∏ Instrument',
            featuring: 'üéµ Featuring'
        };
        
        const categoryList = categories || Object.keys(labels);
        
        categoryList.forEach(cat => {
            const catAnswers = answers.filter(a => a.category === cat && a.answer && a.answer.trim());
            if (!catAnswers.length) return;
            
            const div = document.createElement('div');
            div.className = 'vote-item';
            div.innerHTML = `<h4 style="margin-bottom:8px">${labels[cat] || cat}</h4>`;
            
            catAnswers.forEach(answer => {
                const key = `${answer.user_id}_${cat}`;
                
                if (String(answer.user_id) === String(userId)) {
                    div.innerHTML += `<div class="vote-answer" style="opacity:0.6"><span><strong>${answer.pseudo}:</strong> ${answer.answer}</span><span class="text-muted">(vous)</span></div>`;
                } else {
                    currentVotes[key] = true;
                    div.innerHTML += `<div class="vote-answer"><span><strong>${answer.pseudo}:</strong> ${answer.answer}</span><div class="vote-buttons"><button type="button" class="vote-btn accept active" data-vote="${key}_accept" onclick="vote('${answer.user_id}','${cat}',true)">‚úì</button><button type="button" class="vote-btn reject" data-vote="${key}_reject" onclick="vote('${answer.user_id}','${cat}',false)">‚úó</button></div></div>`;
                }
            });
            
            DOM.votingCategories.appendChild(div);
        });
        
        if (!DOM.votingCategories.children.length) {
            DOM.votingCategories.innerHTML = '<p class="text-muted" style="text-align:center">Aucune r√©ponse √† valider</p>';
        }
    }

    function handleRoundResult(data) {
        currentPhase = 'results';
        
        // IMPORTANT: Cacher voting, afficher results
        if (DOM.votingPhase) DOM.votingPhase.classList.add('hidden');
        if (DOM.answersPhase) DOM.answersPhase.classList.add('hidden');
        if (DOM.roundResult) DOM.roundResult.classList.remove('hidden');
        
        if (DOM.roundScores) {
            DOM.roundScores.innerHTML = '';
            (data.results || []).forEach(result => {
                const div = document.createElement('div');
                div.style.cssText = 'display:flex;justify-content:space-between;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:4px';
                div.innerHTML = `<span>${result.pseudo}</span><span style="color:var(--success)">+${result.points} pts</span>`;
                DOM.roundScores.appendChild(div);
            });
        }
        
        if (data.scores) updateScores(data.scores);
        if (DOM.nextRoundInfo) DOM.nextRoundInfo.textContent = 'Prochaine manche dans quelques secondes...';
    }

    function handleGameEnd(data) {
        currentPhase = 'finished';
        
        DOM.playingState.classList.add('hidden');
        DOM.finishedState.classList.remove('hidden');
        
        if (data.winner) {
            DOM.winnerName.textContent = data.winner.pseudo;
            DOM.winnerScore.textContent = `${data.winner.score} points`;
        }
        
        if (DOM.finalRanking) {
            DOM.finalRanking.innerHTML = '<h4 style="margin-bottom:1rem">Classement final</h4>';
            const ol = document.createElement('ol');
            ol.style.listStyle = 'none';
            (data.rankings || []).forEach((player, index) => {
                const li = document.createElement('li');
                li.style.cssText = 'display:flex;justify-content:space-between;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:4px';
                li.innerHTML = `<span>${index + 1}. ${player.pseudo}</span><span style="font-family:var(--font-mono)">${player.score} pts</span>`;
                ol.appendChild(li);
            });
            DOM.finalRanking.appendChild(ol);
        }
        
        showToast('Partie termin√©e !', 'success', 5000);
    }

    function updateScores(scores) {
        if (!scores || !DOM.scoreList) return;
        
        DOM.scoreList.innerHTML = '';
        let scoresArray = Array.isArray(scores) ? scores : Object.entries(scores).map(([id, data]) => ({ user_id: id, pseudo: data.pseudo, score: data.score }));
        scoresArray.sort((a, b) => b.score - a.score);
        
        scoresArray.forEach(player => {
            const li = document.createElement('li');
            li.innerHTML = `<span style="flex:1">${player.pseudo}</span><span style="font-family:var(--font-mono);font-weight:600">${player.score}</span>`;
            DOM.scoreList.appendChild(li);
            
            const playerScoreEl = document.querySelector(`[data-user-id="${player.user_id}"] .player-score`);
            if (playerScoreEl) playerScoreEl.textContent = player.score;
        });
    }

    function updateStartButton() {
        if (!isHost || !DOM.startBtn) return;
        
        const readyCount = document.querySelectorAll('.player-item.ready').length;
        const totalCount = document.querySelectorAll('.player-item').length;
        
        // Mode solo autoris√© (1 joueur) ou multijoueur (tous pr√™ts sauf l'h√¥te)
        const canStart = totalCount === 1 || (totalCount >= 2 && readyCount >= totalCount - 1);
        
        DOM.startBtn.disabled = !canStart;
        
        if (DOM.startHint) {
            if (totalCount === 1) {
                DOM.startHint.textContent = 'Mode solo - Pr√™t √† jouer !';
            } else if (canStart) {
                DOM.startHint.textContent = 'Tous les joueurs sont pr√™ts !';
            } else {
                DOM.startHint.textContent = `En attente de ${totalCount - 1 - readyCount} joueur(s)...`;
            }
        }
    }

    function updateGameState(status) {
        if (DOM.waitingState) DOM.waitingState.classList.toggle('hidden', status !== 'waiting');
        if (DOM.playingState) DOM.playingState.classList.toggle('hidden', status !== 'playing');
        if (DOM.finishedState) DOM.finishedState.classList.toggle('hidden', status !== 'finished');
        if (status !== 'waiting' && DOM.scoreboard) DOM.scoreboard.classList.remove('hidden');
    }

    function setupInputValidation() {
        document.querySelectorAll('.category-item input').forEach(input => {
            input.addEventListener('input', function() {
                const value = this.value.trim();
                this.classList.remove('valid', 'invalid');
                if (value.length > 0 && currentLetter) {
                    if (value[0].toUpperCase() === currentLetter.toUpperCase()) {
                        this.classList.add('valid');
                    } else {
                        this.classList.add('invalid');
                    }
                }
            });
        });
    }

    function copyCode() {
        navigator.clipboard.writeText(roomCode)
            .then(() => showToast('Code copi√© !', 'success'))
            .catch(() => showToast('Erreur', 'error'));
    }

    function toggleReady() {
        isReady = !isReady;
        sendWS('player_ready', { ready: isReady });
        if (DOM.readyBtn) {
            DOM.readyBtn.classList.toggle('btn-primary', !isReady);
            DOM.readyBtn.classList.toggle('btn-warning', isReady);
        }
        if (DOM.readyBtnText) DOM.readyBtnText.textContent = isReady ? 'Annuler' : 'Je suis pr√™t';
    }

    function startGame() {
        if (!isHost) return showToast('Seul l\'h√¥te peut lancer', 'warning');
        sendWS('start_game', {});
    }

    function submitAnswers(event) {
        if (event) event.preventDefault();
        if (hasSubmittedAnswers) return showToast('D√©j√† envoy√©es', 'info');
        
        const formData = new FormData(DOM.answersForm);
        const answers = {};
        for (let [key, value] of formData.entries()) answers[key] = value.trim();
        
        sendWS('submit_answers', { answers });
        hasSubmittedAnswers = true;
        
        if (DOM.answersForm) DOM.answersForm.classList.add('hidden');
        if (DOM.submittedMessage) DOM.submittedMessage.classList.remove('hidden');
        if (DOM.submitAnswersBtn) DOM.submitAnswersBtn.disabled = true;
        if (DOM.stopBtn) DOM.stopBtn.disabled = true;
    }

    function stopRound() {
        sendWS('stop_round', {});
    }

    function vote(targetUserId, category, accept) {
        const key = `${targetUserId}_${category}`;
        currentVotes[key] = accept;
        document.querySelector(`[data-vote="${key}_accept"]`)?.classList.toggle('active', accept);
        document.querySelector(`[data-vote="${key}_reject"]`)?.classList.toggle('active', !accept);
    }

    function submitVotes() {
        if (hasSubmittedVotes) return showToast('D√©j√† envoy√©s', 'info');
        sendWS('submit_votes', { votes: currentVotes });
        hasSubmittedVotes = true;
        if (DOM.submitVotesBtn) {
            DOM.submitVotesBtn.disabled = true;
            DOM.submitVotesBtn.innerHTML = '‚úì Votes envoy√©s';
        }
    }

    function restartGame() {
        fetch(`/api/rooms/${roomCode}/restart`, { method: 'POST', credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Partie relanc√©e !', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.message || 'Erreur', 'error');
                }
            })
            .catch(() => showToast('Erreur', 'error'));
    }

    function leaveRoom(event) {
        if (event) event.preventDefault();
        if (confirm('Quitter la partie ?')) {
            sendWS('leave_room', {});
            location.href = '/rooms';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        debug('üöÄ Init - roomCode=' + roomCode + ', isHost=' + isHost);
        initDOM();
        connectWebSocket();
        if (isHost) updateStartButton();
        setInterval(() => { if (wsConnected) sendWS('ping', {}); }, 30000);
    });

    window.addEventListener('beforeunload', () => { if (ws) ws.close(1000); });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Room.Name}} - Petit Bac Musical</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/icons.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <span class="icon icon-music icon-md"></span>
            <span>Groupie Tracker</span>
        </a>
        
        <ul class="navbar-nav">
            <li><a href="/">Accueil</a></li>
            <li><a href="/rooms">Salles</a></li>
        </ul>

        <div class="navbar-user">
            <div class="user-info">
                <div class="avatar">{{slice .User.Pseudo 0 1}}</div>
                <span>{{.User.Pseudo}}</span>
            </div>
            <a href="/logout" class="btn btn-secondary btn-sm">D√©connexion</a>
        </div>
    </nav>

    <div class="container">
        <!-- Header de la salle -->
        <header class="room-header" style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 2rem;">
            <div>
                <h1 style="display: flex; align-items: center; gap: 12px;">
                    <span class="icon icon-letters icon-lg"></span>
                    {{.Room.Name}}
                </h1>
                <div style="display: flex; gap: 16px; margin-top: 8px; align-items: center;">
                    <span class="badge badge-secondary">
                        <span class="icon icon-letters icon-xs"></span>
                        Petit Bac Musical
                    </span>
                    <div class="room-code-display" style="display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px; font-family: var(--font-mono);">
                        <span class="icon icon-key icon-sm"></span>
                        <span id="roomCode">{{.Room.Code}}</span>
                        <button class="btn btn-ghost btn-sm" onclick="copyCode()" title="Copier le code">
                            <span class="icon icon-copy icon-xs"></span>
                        </button>
                    </div>
                </div>
            </div>
            <a href="/rooms" class="btn btn-ghost">
                <span class="icon icon-arrow-left icon-sm"></span>
                <span>Quitter</span>
            </a>
        </header>

        <!-- Layout principal -->
        <div class="room-layout" style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">
            
            <!-- Zone de jeu principale -->
            <div class="game-area">
                
                <!-- √âtat: En attente -->
                <div id="waiting-state" class="game-state {{if ne .Room.Status "waiting"}}hidden{{end}}">
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">‚è≥</div>
                        <h2>En attente des joueurs</h2>
                        <p class="text-muted" style="margin: 1rem 0;">
                            Partagez le code <strong style="font-family: var(--font-mono); color: var(--primary);">{{.Room.Code}}</strong> avec vos amis
                        </p>
                        
                        <!-- R√®gles du jeu -->
                        <div style="text-align: left; background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px; margin: 2rem 0;">
                            <h4 style="margin-bottom: 1rem;">üìñ R√®gles du Petit Bac Musical</h4>
                            <ul style="list-style: none; color: var(--text-secondary);">
                                <li style="padding: 8px 0; display: flex; align-items: center; gap: 8px;">
                                    <span class="icon icon-letters icon-sm"></span>
                                    Une lettre al√©atoire est tir√©e √† chaque manche
                                </li>
                                <li style="padding: 8px 0; display: flex; align-items: center; gap: 8px;">
                                    <span class="icon icon-music icon-sm"></span>
                                    5 cat√©gories : Artiste, Titre, Album, Genre, Instrument
                                </li>
                                <li style="padding: 8px 0; display: flex; align-items: center; gap: 8px;">
                                    <span class="icon icon-timer icon-sm"></span>
                                    2 minutes par manche
                                </li>
                                <li style="padding: 8px 0; display: flex; align-items: center; gap: 8px;">
                                    <span class="icon icon-thumb-up icon-sm"></span>
                                    Les r√©ponses sont valid√©es par vote collectif
                                </li>
                            </ul>
                        </div>
                        
                        {{if .IsHost}}
                        <button id="startBtn" class="btn btn-success btn-lg" onclick="startGame()" disabled style="margin-top: 1rem;">
                            <span class="icon icon-play icon-sm"></span>
                            <span>Lancer la partie</span>
                        </button>
                        <p class="text-muted" style="font-size: 0.875rem; margin-top: 0.5rem;">
                            Tous les joueurs doivent √™tre pr√™ts
                        </p>
                        {{else}}
                        <button id="readyBtn" class="btn btn-primary btn-lg" onclick="toggleReady()" style="margin-top: 1rem;">
                            <span class="icon icon-check icon-sm"></span>
                            <span id="readyBtnText">Je suis pr√™t</span>
                        </button>
                        {{end}}
                    </div>
                </div>

                <!-- √âtat: En jeu - Phase de r√©ponse -->
                <div id="playing-state" class="game-state {{if ne .Room.Status "playing"}}hidden{{end}}">
                    <!-- Info manche -->
                    <div class="round-info card" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <span class="text-muted">Manche</span>
                            <strong id="currentRound" style="font-size: 1.5rem; margin-left: 8px;">1</strong>
                            <span class="text-muted">/ <span id="totalRounds">9</span></span>
                        </div>
                        <div id="timer" style="font-size: 2rem; font-family: var(--font-mono); color: var(--primary);">
                            2:00
                        </div>
                    </div>

                    <!-- Lettre du tour -->
                    <div class="card" style="text-align: center; padding: 2rem; margin-bottom: 1.5rem;">
                        <p class="text-muted" style="margin-bottom: 0.5rem;">La lettre est...</p>
                        <div id="currentLetter" style="font-size: 6rem; font-weight: 700; color: var(--primary); text-shadow: 0 0 40px rgba(99, 102, 241, 0.5);">
                            A
                        </div>
                        <p class="text-muted" style="margin-top: 1rem;">
                            Trouvez des mots commen√ßant par cette lettre !
                        </p>
                    </div>

                    <!-- Formulaire des cat√©gories -->
                    <div id="answersPhase" class="card" style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="icon icon-edit icon-sm"></span>
                            Vos r√©ponses
                        </h3>
                        
                        <form id="answersForm" onsubmit="submitAnswers(event)">
                            <div class="categories-grid" style="display: grid; gap: 1rem;">
                                <!-- Artiste -->
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                        <span class="icon icon-user icon-sm"></span>
                                        Artiste
                                    </label>
                                    <input type="text" name="artiste" class="form-control" placeholder="Ex: Adele, ABBA..." autocomplete="off">
                                </div>
                                
                                <!-- Titre -->
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                        <span class="icon icon-music icon-sm"></span>
                                        Titre
                                    </label>
                                    <input type="text" name="titre" class="form-control" placeholder="Ex: All of Me..." autocomplete="off">
                                </div>
                                
                                <!-- Album -->
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                        <span class="icon icon-disc icon-sm"></span>
                                        Album
                                    </label>
                                    <input type="text" name="album" class="form-control" placeholder="Ex: Abbey Road..." autocomplete="off">
                                </div>
                                
                                <!-- Genre -->
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                        <span class="icon icon-tag icon-sm"></span>
                                        Genre
                                    </label>
                                    <input type="text" name="genre" class="form-control" placeholder="Ex: Afrobeat, Ambient..." autocomplete="off">
                                </div>
                                
                                <!-- Instrument -->
                                <div class="category-item" style="display: grid; grid-template-columns: 140px 1fr; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-weight: 500;">
                                        <span class="icon icon-instrument icon-sm"></span>
                                        Instrument
                                    </label>
                                    <input type="text" name="instrument" class="form-control" placeholder="Ex: Accord√©on..." autocomplete="off">
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-primary btn-lg" style="flex: 1;">
                                    <span class="icon icon-check icon-sm"></span>
                                    <span>Valider mes r√©ponses</span>
                                </button>
                                <button type="button" class="btn btn-danger btn-lg" onclick="stopRound()">
                                    <span class="icon icon-stop icon-sm"></span>
                                    <span>STOP !</span>
                                </button>
                            </div>
                        </form>
                        
                        <div id="submittedMessage" class="hidden" style="text-align: center; padding: 2rem; color: var(--success);">
                            <span class="icon icon-check icon-xl"></span>
                            <p style="margin-top: 1rem;">R√©ponses envoy√©es ! En attente des autres joueurs...</p>
                        </div>
                    </div>

                    <!-- Phase de vote -->
                    <div id="votingPhase" class="card hidden" style="padding: 1.5rem;">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 8px;">
                            <span class="icon icon-thumb-up icon-sm"></span>
                            Validation des r√©ponses
                        </h3>
                        
                        <div id="votingCategories">
                            <!-- Les cat√©gories √† voter seront inject√©es ici -->
                        </div>
                        
                        <button id="submitVotesBtn" class="btn btn-primary btn-lg btn-block" onclick="submitVotes()" style="margin-top: 1.5rem;">
                            <span class="icon icon-check icon-sm"></span>
                            <span>Valider les votes</span>
                        </button>
                    </div>

                    <!-- R√©sultat de manche -->
                    <div id="roundResult" class="card hidden" style="padding: 2rem; margin-top: 1.5rem;">
                        <h3 style="text-align: center; margin-bottom: 1.5rem;">üìä R√©sultats de la manche</h3>
                        <div id="roundScores"></div>
                    </div>
                </div>

                <!-- √âtat: Termin√© -->
                <div id="finished-state" class="game-state {{if ne .Room.Status "finished"}}hidden{{end}}">
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèÜ</div>
                        <h2>Partie termin√©e !</h2>
                        
                        <div id="winner" style="margin: 2rem 0; padding: 1.5rem; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); border-radius: 12px;">
                            <p class="text-muted">Vainqueur</p>
                            <h3 id="winnerName" style="font-size: 2rem; color: var(--warning);">-</h3>
                            <p id="winnerScore" style="font-size: 1.25rem;">0 points</p>
                        </div>

                        <div id="finalRanking" style="text-align: left; margin: 2rem 0;"></div>

                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                            {{if .IsHost}}
                            <button class="btn btn-primary btn-lg" onclick="restartGame()">
                                <span class="icon icon-refresh icon-sm"></span>
                                <span>Rejouer</span>
                            </button>
                            {{end}}
                            <a href="/rooms" class="btn btn-secondary btn-lg">
                                <span class="icon icon-arrow-left icon-sm"></span>
                                <span>Retour aux salles</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panneau lat√©ral: Joueurs & Scores -->
            <aside class="sidebar">
                <!-- Liste des joueurs -->
                <div class="card" style="padding: 1.5rem;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">
                        <span class="icon icon-users icon-sm"></span>
                        Joueurs
                        <span class="badge badge-secondary" style="margin-left: auto;">
                            <span id="playerCount">{{len .Room.Players}}</span>/8
                        </span>
                    </h3>
                    
                    <ul id="playersList" style="list-style: none;">
                        {{range $id, $player := .Room.Players}}
                        <li class="player-item" data-user-id="{{$id}}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                            <div class="avatar" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                {{if $player.IsHost}}
                                <span class="icon icon-crown icon-sm" style="color: var(--warning);"></span>
                                {{else}}
                                {{slice $player.Pseudo 0 1}}
                                {{end}}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">{{$player.Pseudo}}</div>
                                <div class="player-status text-muted" style="font-size: 0.75rem;">
                                    {{if $player.IsReady}}
                                    <span style="color: var(--success);">‚úì Pr√™t</span>
                                    {{else}}
                                    <span>En attente</span>
                                    {{end}}
                                </div>
                            </div>
                            <div class="player-score" style="font-family: var(--font-mono); font-weight: 600; color: var(--primary);">
                                {{$player.Score}}
                            </div>
                        </li>
                        {{end}}
                    </ul>
                </div>

                <!-- Statut des r√©ponses (pendant le jeu) -->
                <div id="answersStatus" class="card hidden" style="padding: 1.5rem; margin-top: 1rem;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">
                        <span class="icon icon-edit icon-sm"></span>
                        R√©ponses
                    </h3>
                    <ul id="answersStatusList" style="list-style: none;"></ul>
                </div>

                <!-- Scoreboard -->
                <div id="scoreboard" class="card {{if eq .Room.Status "waiting"}}hidden{{end}}" style="padding: 1.5rem; margin-top: 1rem;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">
                        <span class="icon icon-trophy icon-sm"></span>
                        Classement
                    </h3>
                    <ol id="scoreList" style="list-style: none; counter-reset: ranking;"></ol>
                </div>
            </aside>
        </div>
    </div>

    <style>
        .hidden { display: none !important; }
        
        .player-item.submitted {
            border-left: 3px solid var(--success);
        }
        
        .player-item.ready {
            border-left: 3px solid var(--success);
        }
        
        #scoreList li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            counter-increment: ranking;
        }
        
        #scoreList li::before {
            content: counter(ranking);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        #scoreList li:first-child::before {
            background: var(--warning);
            color: black;
        }
        
        #scoreList li:nth-child(2)::before {
            background: #9CA3AF;
            color: black;
        }
        
        #scoreList li:nth-child(3)::before {
            background: #CD7F32;
            color: black;
        }
        
        .vote-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .vote-answer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .vote-buttons {
            display: flex;
            gap: 8px;
        }
        
        .vote-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .vote-btn.accept {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .vote-btn.accept:hover, .vote-btn.accept.active {
            background: var(--success);
            color: white;
        }
        
        .vote-btn.reject {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .vote-btn.reject:hover, .vote-btn.reject.active {
            background: var(--danger);
            color: white;
        }
        
        .category-item input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        #currentLetter {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>

    <script>
        // Variables globales
        const roomCode = '{{.Room.Code}}';
        const roomId = '{{.Room.ID}}';
        const userId = '{{.User.ID}}';
        const isHost = '{{.IsHost}}';
        let ws = null;
        let isReady = false;
        let timerInterval = null;
        let currentVotes = {};

        // Connexion WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/room/${roomCode}`);
            
            ws.onopen = function() {
                console.log('[WS] Connect√© √† la salle');
            };
            
            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
            
            ws.onclose = function() {
                console.log('[WS] D√©connect√©, reconnexion dans 3s...');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('[WS] Erreur:', error);
            };
        }

        // Gestion des messages
        function handleMessage(msg) {
            console.log('[WS] Message:', msg.type, msg);
            
            switch(msg.type) {
                case 'player_joined':
                    onPlayerJoined(msg.payload);
                    break;
                case 'player_left':
                    onPlayerLeft(msg.payload);
                    break;
                case 'player_ready':
                    onPlayerReady(msg.payload);
                    break;
                case 'game_start':
                    onGameStart(msg.payload);
                    break;
                case 'new_round':
                    onNewRound(msg.payload);
                    break;
                case 'player_submitted':
                    onPlayerSubmitted(msg.payload);
                    break;
                case 'round_stop':
                    onRoundStop(msg.payload);
                    break;
                case 'voting_start':
                    onVotingStart(msg.payload);
                    break;
                case 'round_result':
                    onRoundResult(msg.payload);
                    break;
                case 'game_end':
                    onGameEnd(msg.payload);
                    break;
                case 'scores_update':
                    updateScores(msg.payload);
                    break;
                case 'error':
                    alert(msg.payload.message || 'Une erreur est survenue');
                    break;
            }
        }

        // Copier le code
        function copyCode() {
            navigator.clipboard.writeText(roomCode).then(() => {
                showToast('Code copi√© !');
            });
        }

        // Toggle pr√™t
        function toggleReady() {
            isReady = !isReady;
            ws.send(JSON.stringify({
                type: 'player_ready',
                payload: { ready: isReady }
            }));
            
            const btn = document.getElementById('readyBtn');
            const text = document.getElementById('readyBtnText');
            
            if (isReady) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-warning');
                text.textContent = 'Annuler';
            } else {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-primary');
                text.textContent = 'Je suis pr√™t';
            }
        }

        // Lancer la partie
        function startGame() {
            if (!isHost) return;
            ws.send(JSON.stringify({ type: 'start_game' }));
        }

        // Soumettre les r√©ponses
        function submitAnswers(e) {
            e.preventDefault();
            
            const form = document.getElementById('answersForm');
            const formData = new FormData(form);
            const answers = {};
            
            for (let [key, value] of formData.entries()) {
                answers[key] = value.trim();
            }
            
            ws.send(JSON.stringify({
                type: 'submit_answers',
                payload: { answers: answers }
            }));
            
            // Afficher message de confirmation
            form.classList.add('hidden');
            document.getElementById('submittedMessage').classList.remove('hidden');
        }

        // Arr√™ter la manche (STOP!)
        function stopRound() {
            ws.send(JSON.stringify({ type: 'stop_round' }));
        }

        // Soumettre les votes
        function submitVotes() {
            ws.send(JSON.stringify({
                type: 'submit_votes',
                payload: { votes: currentVotes }
            }));
            
            document.getElementById('submitVotesBtn').disabled = true;
            document.getElementById('submitVotesBtn').textContent = 'Votes envoy√©s...';
        }

        // Voter pour une r√©ponse
        function vote(odplayerId, category, accept) {
            const key = `${odplayerId}_${category}`;
            currentVotes[key] = accept;
            
            // Mettre √† jour l'UI
            const acceptBtn = document.querySelector(`[data-vote="${key}_accept"]`);
            const rejectBtn = document.querySelector(`[data-vote="${key}_reject"]`);
            
            if (accept) {
                acceptBtn.classList.add('active');
                rejectBtn.classList.remove('active');
            } else {
                rejectBtn.classList.add('active');
                acceptBtn.classList.remove('active');
            }
        }

        // Relancer la partie
        function restartGame() {
            ws.send(JSON.stringify({ type: 'restart_game' }));
        }

        // Events handlers
        function onPlayerJoined(data) {
            location.reload();
        }

        function onPlayerLeft(data) {
            location.reload();
        }

        function onPlayerReady(data) {
            const playerItem = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (playerItem) {
                const status = playerItem.querySelector('.player-status');
                if (data.ready) {
                    status.innerHTML = '<span style="color: var(--success);">‚úì Pr√™t</span>';
                    playerItem.classList.add('ready');
                } else {
                    status.innerHTML = '<span>En attente</span>';
                    playerItem.classList.remove('ready');
                }
            }
            updateStartButton();
        }

        function updateStartButton() {
            if (!isHost) return;
            const btn = document.getElementById('startBtn');
            const readyPlayers = document.querySelectorAll('.player-item.ready').length;
            const totalPlayers = document.querySelectorAll('.player-item').length;
            
            const allReady = readyPlayers >= totalPlayers - 1;
            btn.disabled = !allReady && totalPlayers > 1;
        }

        function onGameStart(data) {
            document.getElementById('waiting-state').classList.add('hidden');
            document.getElementById('playing-state').classList.remove('hidden');
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('answersStatus').classList.remove('hidden');
        }

        function onNewRound(data) {
            document.getElementById('currentRound').textContent = data.round;
            document.getElementById('totalRounds').textContent = data.total_rounds || 9;
            document.getElementById('currentLetter').textContent = data.letter;
            
            // Reset du formulaire
            document.getElementById('answersForm').reset();
            document.getElementById('answersForm').classList.remove('hidden');
            document.getElementById('submittedMessage').classList.add('hidden');
            document.getElementById('answersPhase').classList.remove('hidden');
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('roundResult').classList.add('hidden');
            
            // Reset statut des joueurs
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('submitted');
            });
            
            // Timer
            startTimer(data.duration || 120);
            
            // Focus sur le premier champ
            document.querySelector('input[name="artiste"]').focus();
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            let remaining = seconds;
            const timerEl = document.getElementById('timer');
            
            function updateDisplay() {
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 10) {
                    timerEl.style.color = 'var(--danger)';
                } else if (remaining <= 30) {
                    timerEl.style.color = 'var(--warning)';
                } else {
                    timerEl.style.color = 'var(--primary)';
                }
            }
            
            updateDisplay();
            
            timerInterval = setInterval(() => {
                remaining--;
                updateDisplay();
                
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function onPlayerSubmitted(data) {
            const playerItem = document.querySelector(`[data-user-id="${data.user_id}"]`);
            if (playerItem) {
                playerItem.classList.add('submitted');
            }
        }

        function onRoundStop(data) {
            clearInterval(timerInterval);
            document.getElementById('timer').textContent = 'STOP!';
            document.getElementById('timer').style.color = 'var(--danger)';
            
            // Forcer la soumission si pas encore fait
            const form = document.getElementById('answersForm');
            if (!form.classList.contains('hidden')) {
                submitAnswers(new Event('submit'));
            }
            
            showToast(`${data.stopped_by} a cri√© STOP !`);
        }

        function onVotingStart(data) {
            document.getElementById('answersPhase').classList.add('hidden');
            document.getElementById('votingPhase').classList.remove('hidden');
            
            currentVotes = {};
            const container = document.getElementById('votingCategories');
            container.innerHTML = '';
            
            const categories = ['artiste', 'titre', 'album', 'genre', 'instrument'];
            const categoryLabels = {
                artiste: 'Artiste',
                titre: 'Titre',
                album: 'Album',
                genre: 'Genre',
                instrument: 'Instrument'
            };
            
            categories.forEach(category => {
                const categoryAnswers = data.answers.filter(a => a.category === category && a.answer);
                
                if (categoryAnswers.length === 0) return;
                
                const div = document.createElement('div');
                div.className = 'vote-item';
                div.innerHTML = `<h4 style="margin-bottom: 8px;">${categoryLabels[category]}</h4>`;
                
                categoryAnswers.forEach(answer => {
                    // Ne pas voter pour ses propres r√©ponses
                    if (answer.user_id === userId) {
                        div.innerHTML += `
                            <div class="vote-answer" style="opacity: 0.6;">
                                <span><strong>${answer.pseudo}:</strong> ${answer.answer}</span>
                                <span class="text-muted">(votre r√©ponse)</span>
                            </div>
                        `;
                    } else {
                        const voteKey = `${answer.user_id}_${category}`;
                        div.innerHTML += `
                            <div class="vote-answer">
                                <span><strong>${answer.pseudo}:</strong> ${answer.answer}</span>
                                <div class="vote-buttons">
                                    <button class="vote-btn accept" data-vote="${voteKey}_accept" onclick="vote('${answer.user_id}', '${category}', true)">
                                        ‚úì
                                    </button>
                                    <button class="vote-btn reject" data-vote="${voteKey}_reject" onclick="vote('${answer.user_id}', '${category}', false)">
                                        ‚úó
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
                
                container.appendChild(div);
            });
            
            document.getElementById('submitVotesBtn').disabled = false;
            document.getElementById('submitVotesBtn').innerHTML = '<span class="icon icon-check icon-sm"></span><span>Valider les votes</span>';
        }

        function onRoundResult(data) {
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('roundResult').classList.remove('hidden');
            
            const container = document.getElementById('roundScores');
            container.innerHTML = '';
            
            if (data.results) {
                data.results.forEach(result => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 4px;';
                    div.innerHTML = `
                        <span>${result.pseudo}</span>
                        <span style="color: var(--success);">+${result.points} pts</span>
                    `;
                    container.appendChild(div);
                });
            }
            
            updateScores(data.scores);
        }

        function onGameEnd(data) {
            document.getElementById('playing-state').classList.add('hidden');
            document.getElementById('finished-state').classList.remove('hidden');
            
            if (data.winner) {
                document.getElementById('winnerName').textContent = data.winner.pseudo;
                document.getElementById('winnerScore').textContent = data.winner.score + ' points';
            }
            
            // Classement final
            const ranking = document.getElementById('finalRanking');
            ranking.innerHTML = '<h4 style="margin-bottom: 1rem;">Classement final</h4>';
            
            if (data.rankings) {
                const ol = document.createElement('ol');
                ol.style.cssText = 'list-style: none;';
                
                data.rankings.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.style.cssText = 'display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 4px;';
                    li.innerHTML = `
                        <span>${index + 1}. ${player.pseudo}</span>
                        <span style="font-family: var(--font-mono);">${player.score} pts</span>
                    `;
                    ol.appendChild(li);
                });
                
                ranking.appendChild(ol);
            }
        }

        function updateScores(scores) {
            if (!scores) return;
            
            const scoreList = document.getElementById('scoreList');
            scoreList.innerHTML = '';
            
            const sorted = Object.entries(scores).sort((a, b) => b[1].score - a[1].score);
            
            sorted.forEach(([id, player]) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="flex: 1;">${player.pseudo}</span>
                    <span style="font-family: var(--font-mono); font-weight: 600;">${player.score}</span>
                `;
                scoreList.appendChild(li);
                
                const playerItem = document.querySelector(`[data-user-id="${id}"] .player-score`);
                if (playerItem) {
                    playerItem.textContent = player.score;
                }
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--surface); padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialisation
        connectWebSocket();
        
        if (isHost) {
            updateStartButton();
        }
    </script>
</body>
</html>
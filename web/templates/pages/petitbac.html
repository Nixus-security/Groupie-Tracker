{{template "base.html" .}}

{{define "title"}}Petit Bac - Music Platform{{end}}

{{define "styles"}}
<link rel="stylesheet" href="/static/css/games.css">
{{end}}

{{define "content"}}
<div class="game-container petitbac-container">
    <div class="game-header">
        <div class="game-info">
            <span class="game-icon">üéº</span>
            <h1>Petit Bac Musical</h1>
            <span class="room-code">Salle: {{.Room.Code}}</span>
        </div>
        <div class="round-info">
            <span class="round-number">Manche <span id="currentRound">0</span>/{{.Config.TotalRounds}}</span>
        </div>
    </div>

    <div class="game-main">
        <div class="petitbac-section">
            <div class="letter-display">
                <span class="letter-label">Lettre</span>
                <span class="letter-value" id="currentLetter">?</span>
            </div>

            <div class="timer-section">
                <div class="timer-bar">
                    <div class="timer-fill" id="timerFill"></div>
                </div>
                <span class="timer-text" id="timerText">{{.Config.TimePerRound}}s</span>
            </div>

            <div class="categories-form" id="categoriesForm">
                <form onsubmit="submitAnswers(event)" id="answersForm">
                    <div class="categories-grid">
                        {{range .Categories}}
                        <div class="category-item">
                            <label for="cat-{{.ID}}">{{.Name}}</label>
                            <input 
                                type="text" 
                                id="cat-{{.ID}}" 
                                name="{{.ID}}"
                                class="category-input"
                                autocomplete="off"
                                placeholder="{{.Name}} en..."
                            >
                        </div>
                        {{end}}
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        Valider mes r√©ponses
                    </button>
                </form>
            </div>

            <div class="voting-section" id="votingSection" style="display: none;">
                <h2>Phase de vote</h2>
                <p>Validez ou refusez les r√©ponses des autres joueurs</p>
                <div class="answers-to-vote" id="answersToVote"></div>
            </div>

            <div class="results-section" id="resultsSection" style="display: none;">
                <h2>R√©sultats de la manche</h2>
                <div class="round-results" id="roundResults"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="scores-panel">
                <h3>Scores</h3>
                <div class="scores-list" id="scoresList">
                    {{range .Players}}
                    <div class="score-item" data-user-id="{{.ID}}">
                        <span class="player-name">{{.Pseudo}}</span>
                        <span class="player-score">0</span>
                    </div>
                    {{end}}
                </div>
            </div>

            <div class="activity-panel">
                <h3>Activit√©</h3>
                <div class="activity-list" id="activityList"></div>
            </div>
        </div>
    </div>

    <div class="waiting-overlay" id="waitingOverlay">
        <div class="waiting-content">
            <div class="spinner"></div>
            <h2>Pr√©paration de la partie...</h2>
            <p>La manche va bient√¥t commencer</p>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/websocket.js"></script>
<script src="/static/js/animations.js"></script>
<div id="gameData" 
    data-room-code="{{.Room.Code}}" 
    data-game-id="{{if .Game}}{{.Game.ID}}{{else}}0{{end}}"
    data-user-id="{{.User.ID}}"
    data-time-per-round="{{.Config.TimePerRound}}"
    data-nbrs-manche="{{.NbrsManche}}"
    style="display:none;">
</div>
<script>
    const gameData = document.getElementById('gameData');
    const roomCode = gameData.dataset.roomCode;
    const gameId = parseInt(gameData.dataset.gameId);
    const userId = parseInt(gameData.dataset.userId);
    const timePerRound = parseInt(gameData.dataset.timePerRound);
    const nbrsManche = parseInt(gameData.dataset.nbrsManche);
    
    let timerInterval;
    let currentLetter = '';
    let hasSubmitted = false;

    initWebSocket(roomCode);

    function onWebSocketMessage(msg) {
        switch(msg.type) {
            case 'round_start':
                startRound(msg);
                break;
            case 'voting_start':
                startVoting(msg);
                break;
            case 'show_answers':
                showAnswers(msg.answers);
                break;
            case 'vote_update':
                updateVote(msg);
                break;
            case 'round_end':
                endRound(msg);
                break;
            case 'answers_submitted':
                showActivity(msg.pseudo + ' a soumis ses r√©ponses');
                break;
            case 'game_end':
                endGame(msg.scoreboard);
                break;
        }
    }

    function startRound(data) {
        document.getElementById('waitingOverlay').style.display = 'none';
        document.getElementById('currentRound').textContent = data.round;
        document.getElementById('currentLetter').textContent = data.letter;
        document.getElementById('categoriesForm').style.display = 'block';
        document.getElementById('votingSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
        
        currentLetter = data.letter;
        hasSubmitted = false;

        document.querySelectorAll('.category-input').forEach(input => {
            input.value = '';
            input.disabled = false;
            input.placeholder = input.placeholder.split(' en')[0] + ' en ' + data.letter + '...';
        });

        startTimer(data.time);
    }

    function submitAnswers(e) {
        e.preventDefault();
        
        if (hasSubmitted) return;
        hasSubmitted = true;

        const answers = {};
        document.querySelectorAll('.category-input').forEach(input => {
            answers[input.name] = input.value.trim();
            input.disabled = true;
        });

        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = 'R√©ponses envoy√©es ‚úì';

        fetch('/petitbac/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                game_id: gameId,
                answers: answers
            })
        });
    }

    function startVoting(data) {
        clearInterval(timerInterval);
        document.getElementById('categoriesForm').style.display = 'none';
        document.getElementById('votingSection').style.display = 'block';
    }

    function showAnswers(answers) {
        const container = document.getElementById('answersToVote');
        container.innerHTML = '';

        answers.forEach(answer => {
            if (answer.user_id === userId) return;
            if (!answer.answer) return;

            const div = document.createElement('div');
            div.className = 'answer-vote-item';
            div.dataset.answerId = answer.id;
            div.innerHTML = 
                '<div class="answer-info">' +
                    '<span class="answer-category">' + (answer.category_name || 'Cat√©gorie') + '</span>' +
                    '<span class="answer-text">' + answer.answer + '</span>' +
                    '<span class="answer-player">par ' + (answer.pseudo || 'Joueur') + '</span>' +
                '</div>' +
                '<div class="vote-buttons">' +
                    '<button class="btn btn-valid" onclick="vote(' + answer.id + ', true)">‚úì Valide</button>' +
                    '<button class="btn btn-invalid" onclick="vote(' + answer.id + ', false)">‚úó Invalide</button>' +
                '</div>' +
                '<div class="vote-counts">' +
                    '<span class="votes-valid">‚úì ' + answer.votes_valid + '</span>' +
                    '<span class="votes-invalid">‚úó ' + answer.votes_invalid + '</span>' +
                '</div>';
            container.appendChild(div);
        });

        if (container.children.length === 0) {
            container.innerHTML = '<p>Aucune r√©ponse √† voter</p>';
        }
    }

    function vote(answerId, isValid) {
        fetch('/petitbac/vote', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                answer_id: answerId,
                is_valid: isValid
            })
        });

        const item = document.querySelector('.answer-vote-item[data-answer-id="' + answerId + '"]');
        if (item) {
            item.querySelectorAll('.vote-buttons button').forEach(btn => btn.disabled = true);
        }
    }

    function updateVote(data) {
        const item = document.querySelector('.answer-vote-item[data-answer-id="' + data.answer_id + '"]');
        if (item) {
            item.querySelector('.votes-valid').textContent = '‚úì ' + data.votes_valid;
            item.querySelector('.votes-invalid').textContent = '‚úó ' + data.votes_invalid;
            
            if (data.is_validated) {
                item.classList.add('validated');
            }
        }
    }

    function endRound(data) {
        document.getElementById('votingSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';

        if (data.scores) {
            Object.keys(data.scores).forEach(uid => {
                updateScoreDisplay(uid, data.scores[uid]);
            });
        }

        setTimeout(function() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('waitingOverlay').style.display = 'flex';
        }, 5000);
    }

    function startTimer(seconds) {
        let remaining = seconds;
        const timerFill = document.getElementById('timerFill');
        const timerText = document.getElementById('timerText');

        timerFill.style.width = '100%';
        timerText.textContent = remaining + 's';

        timerInterval = setInterval(function() {
            remaining--;
            const percent = (remaining / seconds) * 100;
            timerFill.style.width = percent + '%';
            timerText.textContent = remaining + 's';

            if (remaining <= 0) {
                clearInterval(timerInterval);
                if (!hasSubmitted) {
                    submitAnswers(new Event('submit'));
                }
            }
        }, 1000);
    }

    function updateScoreDisplay(odtUserId, total) {
        const item = document.querySelector('.score-item[data-user-id="' + odtUserId + '"]');
        if (item) {
            item.querySelector('.player-score').textContent = total;
        }
    }

    function showActivity(message) {
        const list = document.getElementById('activityList');
        const div = document.createElement('div');
        div.className = 'activity-item';
        div.textContent = message;
        list.insertBefore(div, list.firstChild);
        
        if (list.children.length > 10) {
            list.removeChild(list.lastChild);
        }
    }

    function endGame(scoreboard) {
        window.location.href = '/scoreboard/' + gameId;
    }
</script>
{{end}}
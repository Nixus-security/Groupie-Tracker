{{template "base.html" .}}

{{define "title"}}Blind Test - Music Platform{{end}}

{{define "styles"}}
<link rel="stylesheet" href="/static/css/games.css">
{{end}}

{{define "content"}}
<div class="game-container blindtest-container">
    <div class="game-header">
        <div class="game-info">
            <span class="game-icon">ðŸŽµ</span>
            <h1>Blind Test</h1>
            <span class="room-code">Salle: {{.Room.Code}}</span>
        </div>
        <div class="round-info" id="roundInfo">
            <span class="round-number">Manche <span id="currentRound">0</span>/{{.Config.TotalRounds}}</span>
        </div>
    </div>

    <div class="game-main">
        <div class="music-section">
            <div class="playlist-info">
                <p class="playlist-description">Choisis une des playlist !</p>
                <span class="playlist-name">{{.Config.Playlist}}</span>
            </div>

            <div class="music-player" id="musicPlayer">
                <div class="player-visual">
                    <div class="album-cover" id="albumCover">
                        <span class="cover-placeholder">ðŸŽµ</span>
                    </div>
                    <div class="sound-wave" id="soundWave">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                </div>
                <audio id="audioPlayer" preload="auto"></audio>
            </div>

            <div class="timer-section">
                <div class="timer-bar">
                    <div class="timer-fill" id="timerFill"></div>
                </div>
                <span class="timer-text" id="timerText">{{.Config.TimePerRound}}s</span>
            </div>

            <div class="answer-section" id="answerSection">
                <form onsubmit="submitAnswer(event)" id="answerForm">
                    <div class="answer-input-group">
                        <input 
                            type="text" 
                            id="answerInput" 
                            placeholder="Titre ou artiste..."
                            autocomplete="off"
                            autofocus
                        >
                        <button type="submit" class="btn btn-primary">Valider</button>
                    </div>
                </form>
                <div class="answer-feedback" id="answerFeedback"></div>
            </div>

            <div class="result-section" id="resultSection" style="display: none;">
                <div class="track-reveal">
                    <img src="" alt="Album" id="revealAlbum" class="reveal-album">
                    <div class="track-info">
                        <h3 id="revealTitle"></h3>
                        <p id="revealArtist"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="scores-panel">
                <h3>Scores</h3>
                <div class="scores-list" id="scoresList">
                    {{range .Players}}
                    <div class="score-item" data-user-id="{{.ID}}">
                        <span class="player-name">{{.Pseudo}}</span>
                        <span class="player-score">0</span>
                    </div>
                    {{end}}
                </div>
            </div>

            <div class="activity-panel">
                <h3>ActivitÃ©</h3>
                <div class="activity-list" id="activityList"></div>
            </div>
        </div>
    </div>

    <div class="waiting-overlay" id="waitingOverlay">
        <div class="waiting-content">
            <div class="spinner"></div>
            <h2>PrÃ©paration de la partie...</h2>
            <p>La musique va bientÃ´t commencer</p>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/websocket.js"></script>
<script src="/static/js/animations.js"></script>
<div id="gameData" 
    data-room-code="{{.Room.Code}}" 
    data-game-id="{{if .Game}}{{.Game.ID}}{{else}}0{{end}}"
    data-user-id="{{.User.ID}}"
    data-time-per-round="{{.Config.TimePerRound}}"
    style="display:none;">
</div>
<script>
    const gameData = document.getElementById('gameData');
    const roomCode = gameData.dataset.roomCode;
    const gameId = parseInt(gameData.dataset.gameId);
    const userId = parseInt(gameData.dataset.userId);
    const timePerRound = parseInt(gameData.dataset.timePerRound);
    
    let timerInterval;
    let roundStartTime;
    let hasAnswered = false;

    initWebSocket(roomCode);

    function onWebSocketMessage(msg) {
        switch(msg.type) {
            case 'round_start':
                startRound(msg);
                break;
            case 'round_end':
                endRound(msg);
                break;
            case 'answer_submitted':
                showActivity(msg.pseudo + ' a rÃ©pondu');
                if (msg.is_correct) {
                    updateScore(msg.user_id, msg.points);
                }
                break;
            case 'game_end':
                endGame(msg.scoreboard);
                break;
        }
    }

    function startRound(data) {
        document.getElementById('waitingOverlay').style.display = 'none';
        document.getElementById('currentRound').textContent = data.round;
        document.getElementById('answerSection').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('answerInput').value = '';
        document.getElementById('answerInput').disabled = false;
        document.getElementById('answerFeedback').innerHTML = '';
        
        hasAnswered = false;
        roundStartTime = Date.now();

        const audio = document.getElementById('audioPlayer');
        audio.src = data.preview_url;
        audio.play();

        document.getElementById('soundWave').classList.add('playing');

        startTimer(data.time);
    }

    function endRound(data) {
        clearInterval(timerInterval);
        
        const audio = document.getElementById('audioPlayer');
        audio.pause();
        
        document.getElementById('soundWave').classList.remove('playing');
        document.getElementById('answerSection').style.display = 'none';
        document.getElementById('resultSection').style.display = 'block';

        if (data.track) {
            document.getElementById('revealTitle').textContent = data.track.name;
            document.getElementById('revealArtist').textContent = data.track.artist;
            if (data.track.image) {
                document.getElementById('revealAlbum').src = data.track.image;
                document.getElementById('revealAlbum').style.display = 'block';
            }
        }

        if (data.scores) {
            Object.keys(data.scores).forEach(uid => {
                updateScoreDisplay(uid, data.scores[uid]);
            });
        }
    }

    function submitAnswer(e) {
        e.preventDefault();
        
        if (hasAnswered) return;
        
        const input = document.getElementById('answerInput');
        const answer = input.value.trim();
        
        if (!answer) return;

        hasAnswered = true;
        input.disabled = true;

        const responseTime = Date.now() - roundStartTime;

        fetch('/blindtest/answer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                game_id: gameId,
                answer: answer,
                response_time: responseTime
            })
        })
        .then(res => res.json())
        .then(data => {
            const feedback = document.getElementById('answerFeedback');
            if (data.is_correct) {
                feedback.innerHTML = '<span class="correct">âœ“ Bonne rÃ©ponse ! +' + data.points + ' pts</span>';
            } else {
                feedback.innerHTML = '<span class="incorrect">âœ— Mauvaise rÃ©ponse</span>';
            }
        });
    }

    function startTimer(seconds) {
        let remaining = seconds;
        const timerFill = document.getElementById('timerFill');
        const timerText = document.getElementById('timerText');

        timerFill.style.width = '100%';
        timerText.textContent = remaining + 's';

        timerInterval = setInterval(() => {
            remaining--;
            const percent = (remaining / seconds) * 100;
            timerFill.style.width = percent + '%';
            timerText.textContent = remaining + 's';

            if (remaining <= 0) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    function updateScore(userId, points) {
        const item = document.querySelector('.score-item[data-user-id="' + userId + '"]');
        if (item) {
            const scoreEl = item.querySelector('.player-score');
            const current = parseInt(scoreEl.textContent) || 0;
            scoreEl.textContent = current + points;
        }
    }

    function updateScoreDisplay(userId, total) {
        const item = document.querySelector('.score-item[data-user-id="' + userId + '"]');
        if (item) {
            item.querySelector('.player-score').textContent = total;
        }
    }

    function showActivity(message) {
        const list = document.getElementById('activityList');
        const div = document.createElement('div');
        div.className = 'activity-item';
        div.textContent = message;
        list.insertBefore(div, list.firstChild);
        
        if (list.children.length > 10) {
            list.removeChild(list.lastChild);
        }
    }

    function endGame(scoreboard) {
        window.location.href = '/scoreboard/' + gameId;
    }
</script>
{{end}}
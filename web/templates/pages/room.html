{{template "base.html" .}}

{{define "title"}}Salle {{.Room.Code}} - Music Platform{{end}}

{{define "styles"}}
<link rel="stylesheet" href="/static/css/main.css">
<link rel="stylesheet" href="/static/css/games.css">
{{end}}

{{define "content"}}
<div class="room-container">
    <div class="room-header">
        <div class="room-title">
            <span class="room-icon">
                {{if eq .Room.GameType "blindtest"}}ðŸŽµ{{else}}ðŸŽ¼{{end}}
            </span>
            <h1>{{if eq .Room.GameType "blindtest"}}Blind Test{{else}}Petit Bac{{end}}</h1>
        </div>
        <div class="room-code-display">
            <span class="code-label">Code de la salle</span>
            <span class="code-value" id="roomCode">{{.Room.Code}}</span>
            <button class="btn btn-sm btn-copy" onclick="copyCode()">Copier</button>
        </div>
    </div>

    <div class="room-content">
        <div class="players-section">
            <h2>Joueurs ({{len .Players}})</h2>
            <div class="players-list" id="playersList">
                {{range .Players}}
                <div class="player-item {{if eq .ID $.Room.CreatorID}}creator{{end}}">
                    <span class="player-avatar">ðŸ‘¤</span>
                    <span class="player-name">{{.Pseudo}}</span>
                    {{if eq .ID $.Room.CreatorID}}
                    <span class="player-badge">ðŸ‘‘ HÃ´te</span>
                    {{end}}
                </div>
                {{end}}
            </div>
        </div>

        <div class="config-section">
            <h2>Configuration</h2>
            {{if eq .Room.GameType "blindtest"}}
            <div class="config-details">
                <div class="config-item">
                    <span class="config-label">Playlist</span>
                    <span class="config-value">{{.Config.Playlist}}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Temps par manche</span>
                    <span class="config-value">{{.Config.TimePerRound}}s</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Nombre de manches</span>
                    <span class="config-value">{{.Config.TotalRounds}}</span>
                </div>
            </div>
            {{else}}
            <div class="config-details">
                <div class="config-item">
                    <span class="config-label">Temps par manche</span>
                    <span class="config-value">{{.Config.TimePerRound}}s</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Nombre de manches</span>
                    <span class="config-value">{{.Config.TotalRounds}}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">CatÃ©gories</span>
                    <span class="config-value">Artiste, Album, Groupe, Instrument, Featuring</span>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <div class="room-actions">
        {{if .IsCreator}}
            {{if .IsReady}}
            <button class="btn btn-primary btn-lg" id="startBtn" onclick="startGame()">
                Lancer la partie
            </button>
            {{else}}
            <button class="btn btn-primary btn-lg" disabled>
                En attente de joueurs...
            </button>
            {{end}}
        {{else}}
        <div class="waiting-message">
            <p>En attente du lancement par l'hÃ´te...</p>
        </div>
        {{end}}
        
        <a href="/lobby" class="btn btn-outline">Quitter la salle</a>
    </div>
</div>

<div class="chat-section">
    <h3>Chat</h3>
    <div class="chat-messages" id="chatMessages"></div>
    <form class="chat-form" onsubmit="sendChat(event)">
        <input type="text" id="chatInput" placeholder="Envoyer un message..." autocomplete="off">
        <button type="submit" class="btn btn-primary">Envoyer</button>
    </form>
</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/websocket.js"></script>
<script>
    const roomCode = "{{.Room.Code}}";
    const gameType = "{{.Room.GameType}}";
    const userId = "{{.User.ID}}";
    const isCreator = "{{.IsCreator}}";
    
    initWebSocket(roomCode);

    function copyCode() {
        navigator.clipboard.writeText(roomCode);
        alert('Code copiÃ© !');
    }

    function startGame() {
        sendMessage({type: 'start_game'});
    }

    function sendChat(e) {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        if (input.value.trim()) {
            sendMessage({
                type: 'chat',
                data: {message: input.value}
            });
            input.value = '';
        }
    }

    function onWebSocketMessage(msg) {
        switch(msg.type) {
            case 'user_joined':
                addPlayer(msg.pseudo);
                addChatMessage('SystÃ¨me', msg.pseudo + ' a rejoint la salle');
                break;
            case 'user_left':
                removePlayer(msg.pseudo);
                addChatMessage('SystÃ¨me', msg.pseudo + ' a quittÃ© la salle');
                break;
            case 'chat':
                addChatMessage(msg.pseudo, msg.message);
                break;
            case 'game_starting':
                window.location.href = '/' + gameType + '/' + roomCode;
                break;
        }
    }

    function addPlayer(pseudo) {
        const list = document.getElementById('playersList');
        const div = document.createElement('div');
        div.className = 'player-item';
        div.innerHTML = '<span class="player-avatar">ðŸ‘¤</span><span class="player-name">' + pseudo + '</span>';
        list.appendChild(div);
    }

    function removePlayer(pseudo) {
        const list = document.getElementById('playersList');
        const items = list.querySelectorAll('.player-item');
        items.forEach(item => {
            if (item.querySelector('.player-name').textContent === pseudo) {
                item.remove();
            }
        });
    }

    function addChatMessage(author, message) {
        const chat = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.innerHTML = '<strong>' + author + ':</strong> ' + message;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }
</script>
{{end}}
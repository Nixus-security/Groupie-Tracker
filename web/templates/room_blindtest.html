<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Room.Name}} - Blind Test - Groupie Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/icons.css">
    <style>
        /* Styles sp√©cifiques au Blind Test */
        #round-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 2rem;
            margin-bottom: 2rem;
        }
        
        #round-number {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        #timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--neon-cyan);
            font-family: 'Monaco', monospace;
        }
        
        #timer.warning {
            color: var(--neon-orange);
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        #timer.danger {
            color: var(--neon-pink);
            animation: pulse 0.3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #audio-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 2rem 0;
        }
        
        .track-image {
            width: 200px;
            height: 200px;
            border-radius: var(--radius-lg);
            object-fit: cover;
            margin-bottom: 1rem;
            transition: filter 0.5s ease;
        }
        
        .track-image.blur {
            filter: blur(20px) brightness(0.5);
        }
        
        .track-image.revealed {
            filter: none;
        }
        
        #answer-form {
            display: flex;
            gap: 1rem;
            max-width: 500px;
            margin: 2rem auto;
        }
        
        #answer-form input {
            flex: 1;
        }
        
        #answer-form.disabled input,
        #answer-form.disabled button {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .answer-feedback {
            text-align: center;
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            font-weight: 600;
        }
        
        .answer-feedback.correct {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
        }
        
        .answer-feedback.wrong {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--neon-pink);
            color: var(--neon-pink);
        }
        
        .reveal-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }
        
        .reveal-card img {
            width: 150px;
            height: 150px;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }
        
        .reveal-card h3 {
            color: var(--neon-cyan);
            margin-bottom: 0.5rem;
        }
        
        .reveal-card p {
            color: var(--text-muted);
        }
        
        .player-found-alert {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .score-row:last-child {
            border-bottom: none;
        }
        
        .score-rank {
            width: 30px;
            color: var(--text-muted);
        }
        
        .score-player {
            flex: 1;
        }
        
        .score-value {
            color: var(--neon-cyan);
            font-weight: 600;
        }
        
        .game-end {
            text-align: center;
            padding: 2rem;
        }
        
        .winner-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
            border: 2px solid gold;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 400px;
        }
        
        .trophy {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .winner-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: gold;
        }
        
        .winner-score {
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <span class="icon icon-music icon-md"></span>
            <span>Groupie Tracker</span>
        </a>
        
        <ul class="navbar-nav">
            <li><a href="/">Accueil</a></li>
            <li><a href="/rooms">Salles</a></li>
        </ul>

        <div class="navbar-user">
            <div class="user-info">
                <div class="avatar">{{slice .User.Pseudo 0 1}}</div>
                <span>{{.User.Pseudo}}</span>
            </div>
            <a href="/logout" class="btn btn-secondary btn-sm">D√©connexion</a>
        </div>
    </nav>

    <!-- Page de salle -->
    <div class="room-page">
        <!-- Zone principale -->
        <div class="room-main">
            <!-- Header de la salle -->
            <div class="room-header">
                <div class="room-title">
                    <h1>
                        <span class="icon icon-headphones icon-lg"></span>
                        {{.Room.Name}}
                    </h1>
                    <span class="badge badge-primary">
                        <span class="icon icon-headphones icon-xs"></span>
                        Blind Test
                    </span>
                </div>
                
                <div class="room-code-display" onclick="copyRoomCode('{{.Room.Code}}')" title="Cliquez pour copier">
                    <span class="icon icon-key icon-sm"></span>
                    <code>{{.Room.Code}}</code>
                    <span class="icon icon-copy icon-sm copy-icon"></span>
                </div>
            </div>

            <!-- Zone de jeu -->
            <div id="game-container">
                <!-- √âtat: En attente -->
                <div id="waiting-state" class="card" style="text-align: center; padding: 3rem;">
                    <div class="game-icon" style="margin-bottom: 2rem;">
                        <span class="icon icon-headphones icon-xxl" style="filter: drop-shadow(0 0 20px var(--primary-glow));"></span>
                    </div>
                    <h2>En attente des joueurs...</h2>
                    <p class="text-muted mb-lg">
                        Partagez le code <strong style="color: var(--neon-cyan);">{{.Room.Code}}</strong> avec vos amis !
                    </p>
                    
                    {{if .Player.IsHost}}
                    <div class="mt-xl">
                        <button class="btn btn-success btn-lg" id="start-btn" onclick="startGame()" disabled>
                            <span class="icon icon-play icon-sm"></span>
                            <span>Lancer la partie</span>
                        </button>
                        <p class="text-muted mt-md" id="start-hint">
                            Tous les joueurs doivent √™tre pr√™ts pour lancer la partie
                        </p>
                    </div>
                    {{else}}
                    <div class="mt-xl">
                        <button class="btn btn-primary btn-lg" id="ready-btn" onclick="toggleReady()">
                            <span class="icon icon-check icon-sm"></span>
                            <span id="ready-text">Je suis pr√™t !</span>
                        </button>
                    </div>
                    {{end}}
                </div>

                <!-- √âtat: Partie en cours -->
                <div id="playing-state" style="display: none;">
                    <div id="round-info">
                        <span id="round-number">Manche 1/10</span>
                        <span id="timer">37s</span>
                    </div>

                    <div id="audio-player">
                        <img src="/static/img/album-placeholder.png" alt="Album" class="track-image blur" id="track-image">
                        <audio id="preview-audio" controls style="width: 100%; max-width: 400px; margin-top: 1rem;">
                            Votre navigateur ne supporte pas l'audio.
                        </audio>
                    </div>

                    <div id="answer-form">
                        <input 
                            type="text" 
                            id="answer-input" 
                            class="form-control"
                            placeholder="Entrez le titre ou l'artiste..."
                            autocomplete="off"
                        >
                        <button class="btn btn-primary btn-lg" id="submit-answer" onclick="submitAnswer()">
                            <span class="icon icon-send icon-sm"></span>
                            <span>Envoyer</span>
                        </button>
                    </div>

                    <div id="answer-feedback" style="display: none;"></div>
                    <div id="player-found-alerts"></div>
                    <div id="reveal-section" style="display: none;"></div>
                </div>

                <!-- √âtat: Partie termin√©e -->
                <div id="finished-state" class="game-end" style="display: none;">
                    <h1>üéâ Partie Termin√©e !</h1>
                    
                    <div class="winner-card" id="winner-card">
                        <div class="trophy">üèÜ</div>
                        <div class="winner-name" id="winner-name">Chargement...</div>
                        <div class="winner-score" id="winner-score"></div>
                    </div>
                    
                    <div class="final-rankings" id="final-rankings">
                        <h3>Classement Final</h3>
                        <div id="final-scores"></div>
                    </div>
                    
                    <div class="room-actions mt-xl">
                        {{if .Player.IsHost}}
                        <button class="btn btn-primary btn-lg" onclick="restartGame()">
                            <span class="icon icon-refresh icon-sm"></span>
                            <span>Rejouer</span>
                        </button>
                        {{end}}
                        <a href="/rooms" class="btn btn-secondary btn-lg">
                            <span class="icon icon-arrow-left icon-sm"></span>
                            <span>Retour aux salles</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel des joueurs -->
        <div class="players-panel">
            <h2>
                <span class="icon icon-users icon-md"></span>
                Joueurs (<span id="player-count">{{len .Room.Players}}</span>/8)
            </h2>
            
            <div class="players-list" id="players-list">
                {{range $userID, $player := .Room.Players}}
                <div class="player-item {{if $player.IsHost}}is-host{{end}} {{if eq $userID $.User.ID}}is-self{{end}}" data-user-id="{{$userID}}">
                    <div class="player-avatar">
                        {{slice $player.Pseudo 0 1}}
                    </div>
                    <div class="player-info">
                        <div class="player-name">
                            {{$player.Pseudo}}
                            {{if $player.IsHost}}
                            <span class="icon icon-crown icon-xs crown" title="H√¥te"></span>
                            {{end}}
                        </div>
                        <div class="player-status">
                            {{if $player.IsReady}}
                            <span class="text-success">Pr√™t</span>
                            {{else}}
                            <span class="text-muted">En attente</span>
                            {{end}}
                        </div>
                    </div>
                    <div class="player-ready-icon {{if $player.IsReady}}ready{{else}}not-ready{{end}}">
                        {{if $player.IsReady}}
                        <span class="icon icon-check icon-sm"></span>
                        {{else}}
                        <span class="icon icon-timer icon-sm"></span>
                        {{end}}
                    </div>
                </div>
                {{end}}
            </div>

            <!-- Scoreboard -->
            <div class="scoreboard" id="scoreboard" style="display: none;">
                <h3>
                    <span class="icon icon-trophy icon-sm"></span>
                    Scores
                </h3>
                <div class="scoreboard-list" id="scoreboard-list"></div>
            </div>

            <!-- Bouton quitter -->
            <div class="mt-lg">
                <button class="btn btn-danger btn-block" onclick="leaveRoom()">
                    <span class="icon icon-door icon-sm"></span>
                    <span>Quitter la salle</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    // =========================================================================
    // TOAST NOTIFICATIONS
    // =========================================================================
    function showToast(message, type, duration) {
        type = type || 'info';
        duration = duration || 3000;
        
        var container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        
        var icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
        toast.innerHTML = '<span class="toast-icon">' + (icons[type] || icons.info) + '</span>' +
                          '<span class="toast-message">' + message + '</span>';

        container.appendChild(toast);

        setTimeout(function() {
            toast.classList.add('toast-exit');
            setTimeout(function() { toast.remove(); }, 300);
        }, duration);
    }

    // =========================================================================
    // VARIABLES GLOBALES
    // =========================================================================
    var ws = null;
    var wsConnected = false;
    var wsReconnectAttempts = 0;
    var wsMaxReconnectAttempts = 5;

    var roomCode = '{{.Room.Code}}';
    var roomId = '{{.Room.ID}}';
    var currentUserId = '{{.User.ID}}';
    var roomStatus = '{{.Room.Status}}';
    var isHost = '{{.Player.IsHost}}' === 'true';
    var isReady = '{{.Player.IsReady}}' === 'true';
    var hasAnswered = false;
    var currentRound = 0;
    var totalRounds = 10;

    // =========================================================================
    // WEBSOCKET
    // =========================================================================
    function connectWebSocket(roomCode) {
        var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        var wsUrl = protocol + '//' + window.location.host + '/ws/room/' + roomCode;
        
        console.log('üîå Connexion WebSocket:', wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('‚úÖ WebSocket connect√©');
                wsConnected = true;
                wsReconnectAttempts = 0;
                showToast('Connect√© √† la salle', 'success');
            };
            
            ws.onclose = function(event) {
                console.log('üîå WebSocket ferm√©:', event.code);
                wsConnected = false;
                
                if (!event.wasClean && wsReconnectAttempts < wsMaxReconnectAttempts) {
                    wsReconnectAttempts++;
                    var delay = 1000 * wsReconnectAttempts;
                    console.log('üîÑ Reconnexion dans ' + delay + 'ms...');
                    setTimeout(function() { connectWebSocket(roomCode); }, delay);
                }
            };
            
            ws.onerror = function(error) {
                console.error('‚ùå Erreur WebSocket:', error);
            };
            
            ws.onmessage = function(event) {
                try {
                    var message = JSON.parse(event.data);
                    handleWSMessage(message);
                } catch (e) {
                    console.error('Erreur parsing:', e);
                }
            };
        } catch (error) {
            console.error('‚ùå Erreur cr√©ation WebSocket:', error);
        }
    }

    function sendWS(type, payload) {
        if (!wsConnected || !ws) {
            console.warn('WebSocket non connect√©');
            return false;
        }
        var message = { type: type, payload: payload || {} };
        ws.send(JSON.stringify(message));
        console.log('üì§ Envoy√©:', type);
        return true;
    }

    function handleWSMessage(message) {
        console.log('üì® Re√ßu:', message.type, message);
        
        switch(message.type) {
            // Messages de salle
            case 'player_ready':
                onPlayerReady(message.payload);
                break;
            case 'player_joined':
                showToast(message.payload.pseudo + ' a rejoint la salle', 'info');
                addPlayerToUI(message.payload);
                break;
            case 'player_left':
                showToast(message.payload.pseudo + ' a quitt√© la salle', 'warning');
                removePlayerFromUI(message.payload.user_id);
                break;
            case 'room_update':
                onRoomUpdate(message.payload);
                break;
            case 'start_game':
                onGameStart(message.payload);
                break;
            
            // Messages Blind Test
            case 'bt_new_round':
                onNewRound(message.payload);
                break;
            case 'time_update':
                onTimeUpdate(message.payload);
                break;
            case 'bt_result':
                onAnswerResult(message.payload);
                break;
            case 'player_found':
                onPlayerFound(message.payload);
                break;
            case 'bt_reveal':
                onReveal(message.payload);
                break;
            case 'bt_scores':
                onScoresUpdate(message.payload);
                break;
            case 'bt_game_end':
                onGameEnd(message.payload);
                break;
            
            case 'error':
                showToast(message.error || 'Erreur', 'error');
                break;
        }
    }

    // =========================================================================
    // GESTIONNAIRES D'√âV√âNEMENTS SALLE
    // =========================================================================
    function onRoomUpdate(data) {
        if (data.status) {
            roomStatus = data.status;
        }
    }

    function onPlayerReady(data) {
        var playerItem = document.querySelector('[data-user-id="' + data.user_id + '"]');
        if (playerItem) {
            var statusEl = playerItem.querySelector('.player-status span');
            var readyIcon = playerItem.querySelector('.player-ready-icon');
            
            if (data.ready) {
                if (statusEl) {
                    statusEl.className = 'text-success';
                    statusEl.textContent = 'Pr√™t';
                }
                if (readyIcon) {
                    readyIcon.className = 'player-ready-icon ready';
                    readyIcon.innerHTML = '<span class="icon icon-check icon-sm"></span>';
                }
            } else {
                if (statusEl) {
                    statusEl.className = 'text-muted';
                    statusEl.textContent = 'En attente';
                }
                if (readyIcon) {
                    readyIcon.className = 'player-ready-icon not-ready';
                    readyIcon.innerHTML = '<span class="icon icon-timer icon-sm"></span>';
                }
            }
        }
        updateStartButton();
    }

    // =========================================================================
    // GESTIONNAIRES BLIND TEST
    // =========================================================================
    function onGameStart(data) {
        showToast('La partie commence !', 'success');
        roomStatus = 'playing';
        
        document.getElementById('waiting-state').style.display = 'none';
        document.getElementById('playing-state').style.display = 'block';
        document.getElementById('scoreboard').style.display = 'block';
        
        totalRounds = data.rounds || 10;
    }

    function onNewRound(data) {
        console.log('üéµ Nouvelle manche:', data);
        
        currentRound = data.round;
        hasAnswered = false;
        
        // Mise √† jour UI
        document.getElementById('round-number').textContent = 'Manche ' + data.round + '/' + data.total;
        document.getElementById('timer').textContent = data.duration + 's';
        document.getElementById('timer').className = '';
        
        // R√©initialiser le formulaire
        var answerForm = document.getElementById('answer-form');
        answerForm.classList.remove('disabled');
        document.getElementById('answer-input').disabled = false;
        document.getElementById('answer-input').value = '';
        document.getElementById('submit-answer').disabled = false;
        
        // Cacher les sections de feedback
        document.getElementById('answer-feedback').style.display = 'none';
        document.getElementById('player-found-alerts').innerHTML = '';
        document.getElementById('reveal-section').style.display = 'none';
        
        // Image floue
        var trackImage = document.getElementById('track-image');
        trackImage.classList.add('blur');
        trackImage.classList.remove('revealed');
        trackImage.src = '/static/img/album-placeholder.png';
        
        // Charger et jouer l'audio
        var audio = document.getElementById('preview-audio');
        if (data.preview_url) {
            audio.src = data.preview_url;
            audio.load();
            audio.play().catch(function(e) {
                console.log('Autoplay bloqu√©:', e);
                showToast('Cliquez sur play pour √©couter', 'info');
            });
        }
    }

    function onTimeUpdate(data) {
        var timerEl = document.getElementById('timer');
        timerEl.textContent = data.time_left + 's';
        
        // Changer la couleur selon le temps
        if (data.time_left <= 5) {
            timerEl.className = 'danger';
        } else if (data.time_left <= 10) {
            timerEl.className = 'warning';
        } else {
            timerEl.className = '';
        }
    }

    function onAnswerResult(data) {
        var feedback = document.getElementById('answer-feedback');
        
        if (data.already_answered) {
            feedback.className = 'answer-feedback wrong';
            feedback.textContent = 'Vous avez d√©j√† r√©pondu !';
        } else if (data.is_correct) {
            feedback.className = 'answer-feedback correct';
            feedback.textContent = '‚úì Bonne r√©ponse ! +' + data.points + ' points';
        } else {
            feedback.className = 'answer-feedback wrong';
            feedback.textContent = '‚úï Mauvaise r√©ponse...';
            // Permettre de r√©essayer
            document.getElementById('answer-input').disabled = false;
            document.getElementById('submit-answer').disabled = false;
            document.getElementById('answer-form').classList.remove('disabled');
        }
        
        feedback.style.display = 'block';
    }

    function onPlayerFound(data) {
        var alertsContainer = document.getElementById('player-found-alerts');
        var alert = document.createElement('div');
        alert.className = 'player-found-alert';
        alert.innerHTML = 'üéâ <strong>' + data.pseudo + '</strong> a trouv√© ! (+' + data.points + ' pts)';
        alertsContainer.appendChild(alert);
        
        showToast(data.pseudo + ' a trouv√© la r√©ponse !', 'success');
    }

    function onReveal(data) {
        console.log('üîì R√©v√©lation:', data);
        
        // Arr√™ter l'audio
        var audio = document.getElementById('preview-audio');
        audio.pause();
        
        // Afficher la r√©ponse
        var revealSection = document.getElementById('reveal-section');
        revealSection.innerHTML = '<div class="reveal-card">' +
            '<img src="' + (data.image_url || '/static/img/album-placeholder.png') + '" alt="Album">' +
            '<h3>' + data.track_name + '</h3>' +
            '<p>' + data.artist_name + '</p>' +
            '<p class="text-muted">' + data.album_name + '</p>' +
            '</div>';
        revealSection.style.display = 'block';
        
        // R√©v√©ler l'image
        var trackImage = document.getElementById('track-image');
        if (data.image_url) {
            trackImage.src = data.image_url;
        }
        trackImage.classList.remove('blur');
        trackImage.classList.add('revealed');
        
        // D√©sactiver le formulaire
        document.getElementById('answer-form').classList.add('disabled');
    }

    function onScoresUpdate(scores) {
        var list = document.getElementById('scoreboard-list');
        list.innerHTML = '';
        
        scores.forEach(function(score, index) {
            var row = document.createElement('div');
            row.className = 'score-row';
            row.innerHTML = '<span class="score-rank">' + (index + 1) + '.</span>' +
                '<span class="score-player">' + score.pseudo + '</span>' +
                '<span class="score-value">' + score.score + ' pts</span>';
            list.appendChild(row);
        });
    }

    function onGameEnd(data) {
        console.log('üèÅ Fin de partie:', data);
        roomStatus = 'finished';
        
        document.getElementById('playing-state').style.display = 'none';
        document.getElementById('finished-state').style.display = 'block';
        
        // Afficher le gagnant
        document.getElementById('winner-name').textContent = data.winner || 'Personne';
        
        if (data.scores && data.scores.length > 0) {
            document.getElementById('winner-score').textContent = data.scores[0].score + ' points';
            
            // Afficher le classement final
            var finalScores = document.getElementById('final-scores');
            finalScores.innerHTML = '';
            data.scores.forEach(function(score, index) {
                var row = document.createElement('div');
                row.className = 'score-row';
                row.innerHTML = '<span class="score-rank">' + (index + 1) + '.</span>' +
                    '<span class="score-player">' + score.pseudo + '</span>' +
                    '<span class="score-value">' + score.score + ' pts</span>';
                finalScores.appendChild(row);
            });
        }
        
        showToast('Partie termin√©e !', 'success', 5000);
    }

    // =========================================================================
    // ACTIONS UTILISATEUR
    // =========================================================================
    function copyRoomCode(code) {
        navigator.clipboard.writeText(code).then(function() {
            showToast('Code copi√© !', 'success');
        }).catch(function() {
            showToast('Erreur lors de la copie', 'error');
        });
    }

    function toggleReady() {
        isReady = !isReady;
        sendWS('player_ready', { ready: isReady });
        
        var btn = document.getElementById('ready-btn');
        var text = document.getElementById('ready-text');
        
        if (isReady) {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-warning');
            text.textContent = 'Annuler';
        } else {
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-primary');
            text.textContent = 'Je suis pr√™t !';
        }
    }

    function startGame() {
        if (!isHost) {
            showToast('Seul l\'h√¥te peut lancer la partie', 'warning');
            return;
        }
        sendWS('start_game', {});
    }

    function submitAnswer() {
        var input = document.getElementById('answer-input');
        var answer = input.value.trim();
        
        if (!answer) {
            showToast('Entrez une r√©ponse', 'warning');
            return;
        }

        sendWS('bt_answer', { answer: answer });
        input.value = '';
        input.disabled = true;
        document.getElementById('submit-answer').disabled = true;
        document.getElementById('answer-form').classList.add('disabled');
    }

    function leaveRoom() {
        if (confirm('Voulez-vous vraiment quitter la salle ?')) {
            sendWS('leave_room', {});
            window.location.href = '/rooms';
        }
    }

    function restartGame() {
        fetch('/api/rooms/' + roomCode + '/restart', {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('Partie relanc√©e !', 'success');
                setTimeout(function() { window.location.reload(); }, 1000);
            } else {
                showToast(data.message || 'Erreur', 'error');
            }
        })
        .catch(function(err) {
            showToast('Erreur de connexion', 'error');
        });
    }

    function updateStartButton() {
        var startBtn = document.getElementById('start-btn');
        var hint = document.getElementById('start-hint');
        
        if (!startBtn) return;

        var playerItems = document.querySelectorAll('.player-item');
        var playerCount = playerItems.length;
        var nonHostNotReady = 0;

        playerItems.forEach(function(item) {
            if (!item.classList.contains('is-host')) {
                var readyIcon = item.querySelector('.player-ready-icon');
                if (readyIcon && readyIcon.classList.contains('not-ready')) {
                    nonHostNotReady++;
                }
            }
        });

        var canStart = (playerCount === 1) || (nonHostNotReady === 0);
        
        startBtn.disabled = !canStart;
        
        if (hint) {
            if (playerCount === 1) {
                hint.textContent = 'Mode solo disponible - Lancez quand vous voulez !';
            } else if (canStart) {
                hint.textContent = 'Tous les joueurs sont pr√™ts !';
            } else {
                hint.textContent = 'En attente de ' + nonHostNotReady + ' joueur(s)...';
            }
        }
    }

    function addPlayerToUI(player) {
        var list = document.getElementById('players-list');
        if (!list) return;
        
        if (document.querySelector('[data-user-id="' + player.user_id + '"]')) return;
        
        var div = document.createElement('div');
        div.className = 'player-item';
        div.dataset.userId = player.user_id;
        div.innerHTML = '<div class="player-avatar">' + player.pseudo.charAt(0) + '</div>' +
            '<div class="player-info"><div class="player-name">' + player.pseudo + '</div>' +
            '<div class="player-status"><span class="text-muted">En attente</span></div></div>' +
            '<div class="player-ready-icon not-ready"><span class="icon icon-timer icon-sm"></span></div>';
        list.appendChild(div);
        
        document.getElementById('player-count').textContent = list.children.length;
        updateStartButton();
    }

    function removePlayerFromUI(userId) {
        var el = document.querySelector('[data-user-id="' + userId + '"]');
        if (el) el.remove();
        
        var list = document.getElementById('players-list');
        document.getElementById('player-count').textContent = list.children.length;
        updateStartButton();
    }

    // =========================================================================
    // INITIALISATION
    // =========================================================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéÆ Initialisation salle:', roomCode, 'Status:', roomStatus);
        
        // Afficher le bon √©tat initial
        if (roomStatus === 'playing') {
            document.getElementById('waiting-state').style.display = 'none';
            document.getElementById('playing-state').style.display = 'block';
            document.getElementById('scoreboard').style.display = 'block';
        } else if (roomStatus === 'finished') {
            document.getElementById('waiting-state').style.display = 'none';
            document.getElementById('finished-state').style.display = 'block';
        }
        
        // Connexion WebSocket
        connectWebSocket(roomCode);
        
        // Mettre √† jour le bouton start
        updateStartButton();
        
        // Gestionnaire touche Entr√©e
        var answerInput = document.getElementById('answer-input');
        if (answerInput) {
            answerInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            });
        }
    });
    </script>
</body>
</html>
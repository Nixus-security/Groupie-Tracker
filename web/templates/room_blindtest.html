<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Room.Name}} - Blind Test - Groupie Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/icons.css">
    <style>
        /* Styles sp√©cifiques au Blind Test */
        #round-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem 2rem;
            margin-bottom: 2rem;
        }
        
        #round-number {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        #timer {
            font-size: 2rem;
            font-weight: 700;
            color: var(--neon-cyan);
            font-family: 'Monaco', monospace;
        }
        
        #timer.warning {
            color: var(--neon-orange);
            animation: pulse 0.5s ease-in-out infinite;
        }
        
        #timer.danger {
            color: var(--neon-pink);
            animation: pulse 0.3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #audio-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 2rem 0;
        }
        
        .track-image {
            width: 200px;
            height: 200px;
            border-radius: var(--radius-lg);
            object-fit: cover;
            margin-bottom: 1rem;
            transition: filter 0.5s ease;
        }
        
        .track-image.blur {
            filter: blur(20px) brightness(0.5);
        }
        
        .track-image.revealed {
            filter: none;
        }
        
        #answer-form {
            display: flex;
            gap: 1rem;
            max-width: 500px;
            margin: 2rem auto;
        }
        
        #answer-form input {
            flex: 1;
        }
        
        #answer-form.disabled input,
        #answer-form.disabled button {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .answer-feedback {
            text-align: center;
            padding: 1rem;
            border-radius: var(--radius-md);
            margin: 1rem 0;
            font-weight: 600;
        }
        
        .answer-feedback.correct {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
        }
        
        .answer-feedback.wrong {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--neon-pink);
            color: var(--neon-pink);
        }
        
        .reveal-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }
        
        .reveal-card img {
            width: 150px;
            height: 150px;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }
        
        .reveal-card h3 {
            color: var(--neon-cyan);
            margin-bottom: 0.5rem;
        }
        
        .reveal-card p {
            color: var(--text-muted);
        }
        
        .player-found-alert {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .score-row:last-child {
            border-bottom: none;
        }
        
        .score-rank {
            width: 30px;
            color: var(--text-muted);
        }
        
        .score-player {
            flex: 1;
        }
        
        .score-value {
            color: var(--neon-cyan);
            font-weight: 600;
        }
        
        .game-end {
            text-align: center;
            padding: 2rem;
        }
        
        .winner-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1));
            border: 2px solid gold;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 400px;
        }
        
        .trophy {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .winner-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: gold;
        }
        
        .winner-score {
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        /* Loading indicator am√©lior√© */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--neon-cyan);
            font-size: 1.2rem;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        .loading-progress-bar {
            height: 100%;
            background: var(--neon-cyan);
            width: 0%;
            transition: width 0.3s;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Audio controls custom */
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem 2rem;
            border-radius: var(--radius-lg);
            margin-top: 1rem;
        }
        
        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--neon-cyan);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }
        
        .play-btn:hover {
            transform: scale(1.1);
            background: var(--neon-green);
        }
        
        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-green));
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .volume-slider {
            width: 80px;
            background: rgba(255, 255, 255, 0.1);
            height: 4px;
            border-radius: 2px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--neon-cyan);
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Indicateur de connexion */
        .connection-status {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .connection-status.connected {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
        }
        
        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--neon-pink);
            color: var(--neon-pink);
        }
        
        .connection-status.connecting {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid var(--neon-orange);
            color: var(--neon-orange);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .status-dot.pulsing {
            animation: statusPulse 1s ease-in-out infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <span class="icon icon-music icon-md"></span>
            <span>Groupie Tracker</span>
        </a>
        
        <ul class="navbar-nav">
            <li><a href="/">Accueil</a></li>
            <li><a href="/rooms">Salles</a></li>
        </ul>

        <div class="navbar-user">
            <div class="user-info">
                <div class="avatar">{{slice .User.Pseudo 0 1}}</div>
                <span>{{.User.Pseudo}}</span>
            </div>
            <a href="/logout" class="btn btn-secondary btn-sm">D√©connexion</a>
        </div>
    </nav>

    <!-- Indicateur de connexion -->
    <div id="connection-status" class="connection-status connecting">
        <span class="status-dot pulsing"></span>
        <span id="connection-text">Connexion...</span>
    </div>

    <!-- Loading overlay am√©lior√© -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Chargement...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loading-progress"></div>
        </div>
    </div>

    <!-- Page de salle -->
    <div class="room-page">
        <!-- Zone principale -->
        <div class="room-main">
            <!-- Header de la salle -->
            <div class="room-header">
                <div class="room-title">
                    <h1>
                        <span class="icon icon-headphones icon-lg"></span>
                        {{.Room.Name}}
                    </h1>
                    <span class="badge badge-primary">
                        <span class="icon icon-headphones icon-xs"></span>
                        Blind Test
                    </span>
                </div>
                
                <div class="room-code-display" onclick="copyRoomCode('{{.Room.Code}}')" title="Cliquez pour copier">
                    <span class="icon icon-key icon-sm"></span>
                    <code>{{.Room.Code}}</code>
                    <span class="icon icon-copy icon-sm copy-icon"></span>
                </div>
            </div>

            <!-- Zone de jeu -->
            <div id="game-container">
                <!-- √âtat: En attente -->
                <div id="waiting-state" class="card" style="text-align: center; padding: 3rem;">
                    <div class="game-icon" style="margin-bottom: 2rem;">
                        <span class="icon icon-headphones icon-xxl" style="filter: drop-shadow(0 0 20px var(--primary-glow));"></span>
                    </div>
                    <h2>En attente des joueurs...</h2>
                    <p class="text-muted mb-lg">
                        Partagez le code <strong style="color: var(--neon-cyan);">{{.Room.Code}}</strong> avec vos amis !
                    </p>
                    
                    {{if .Player.IsHost}}
                    <div class="mt-xl">
                        <button class="btn btn-success btn-lg" id="start-btn" onclick="startGame()" disabled>
                            <span class="icon icon-play icon-sm"></span>
                            <span>Lancer la partie</span>
                        </button>
                        <p class="text-muted mt-md" id="start-hint">
                            Tous les joueurs doivent √™tre pr√™ts pour lancer la partie
                        </p>
                    </div>
                    {{else}}
                    <div class="mt-xl">
                        <button class="btn btn-primary btn-lg" id="ready-btn" onclick="toggleReady()">
                            <span class="icon icon-check icon-sm"></span>
                            <span id="ready-text">Je suis pr√™t !</span>
                        </button>
                    </div>
                    {{end}}
                </div>

                <!-- √âtat: Partie en cours -->
                <div id="playing-state" class="hidden">
                    <div id="round-info">
                        <span id="round-number">Manche 1/10</span>
                        <span id="timer">30s</span>
                    </div>

                    <div id="audio-player">
                        <img src="/static/img/album-placeholder.png" alt="Album" class="track-image blur" id="track-image">
                        
                        <!-- Contr√¥les audio custom -->
                        <div class="audio-controls">
                            <button class="play-btn" id="play-btn" onclick="togglePlay()">
                                <span class="icon icon-play icon-md" id="play-icon"></span>
                            </button>
                            <div class="progress-bar" id="progress-bar" onclick="seekAudio(event)">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="volume-control">
                                <span class="icon icon-volume icon-sm"></span>
                                <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="80" onchange="setVolume(this.value)">
                            </div>
                        </div>
                        
                        <!-- Audio cach√© -->
                        <audio id="main-audio" preload="auto" crossorigin="anonymous"></audio>
                        <audio id="preload-audio" preload="auto" crossorigin="anonymous" style="display: none;"></audio>
                    </div>

                    <div id="answer-form">
                        <input 
                            type="text" 
                            id="answer-input" 
                            class="form-control"
                            placeholder="Entrez le titre ou l'artiste..."
                            autocomplete="off"
                        >
                        <button class="btn btn-primary btn-lg" id="submit-answer" onclick="submitAnswer()">
                            <span class="icon icon-send icon-sm"></span>
                            <span>Envoyer</span>
                        </button>
                    </div>

                    <div id="answer-feedback" class="hidden"></div>
                    <div id="player-found-alerts"></div>
                    <div id="reveal-section" class="hidden"></div>
                </div>

                <!-- √âtat: Partie termin√©e -->
                <div id="finished-state" class="game-end hidden">
                    <h1>üéâ Partie Termin√©e !</h1>
                    
                    <div class="winner-card" id="winner-card">
                        <div class="trophy">üèÜ</div>
                        <div class="winner-name" id="winner-name">Chargement...</div>
                        <div class="winner-score" id="winner-score"></div>
                    </div>
                    
                    <div class="final-rankings" id="final-rankings">
                        <h3>Classement Final</h3>
                        <div id="final-scores"></div>
                    </div>
                    
                    <div class="room-actions mt-xl">
                        {{if .Player.IsHost}}
                        <button class="btn btn-primary btn-lg" onclick="restartGame()">
                            <span class="icon icon-refresh icon-sm"></span>
                            <span>Rejouer</span>
                        </button>
                        {{end}}
                        <a href="/rooms" class="btn btn-secondary btn-lg">
                            <span class="icon icon-arrow-left icon-sm"></span>
                            <span>Retour aux salles</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel des joueurs -->
        <div class="players-panel">
            <h2>
                <span class="icon icon-users icon-md"></span>
                Joueurs (<span id="player-count">{{len .Room.Players}}</span>/8)
            </h2>
            
            <div class="players-list" id="players-list">
                {{range $userID, $player := .Room.Players}}
                <div class="player-item {{if $player.IsHost}}is-host{{end}} {{if eq $userID $.User.ID}}is-self{{end}}" data-user-id="{{$userID}}">
                    <div class="player-avatar">
                        {{slice $player.Pseudo 0 1}}
                    </div>
                    <div class="player-info">
                        <div class="player-name">
                            {{$player.Pseudo}}
                            {{if $player.IsHost}}
                            <span class="icon icon-crown icon-xs crown" title="H√¥te"></span>
                            {{end}}
                        </div>
                        <div class="player-status">
                            {{if $player.IsReady}}
                            <span class="text-success">Pr√™t</span>
                            {{else}}
                            <span class="text-muted">En attente</span>
                            {{end}}
                        </div>
                    </div>
                    <div class="player-ready-icon {{if $player.IsReady}}ready{{else}}not-ready{{end}}">
                        {{if $player.IsReady}}
                        <span class="icon icon-check icon-sm"></span>
                        {{else}}
                        <span class="icon icon-timer icon-sm"></span>
                        {{end}}
                    </div>
                </div>
                {{end}}
            </div>

            <!-- Scoreboard -->
            <div class="scoreboard hidden" id="scoreboard">
                <h3>
                    <span class="icon icon-trophy icon-sm"></span>
                    Scores
                </h3>
                <div class="scoreboard-list" id="scoreboard-list"></div>
            </div>

            <!-- Bouton quitter -->
            <div class="mt-lg">
                <button class="btn btn-danger btn-block" onclick="leaveRoom()">
                    <span class="icon icon-door icon-sm"></span>
                    <span>Quitter la salle</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    // =========================================================================
    // CONFIGURATION ET CONSTANTES
    // =========================================================================
    const CONFIG = {
        WS_RECONNECT_DELAY: 1000,
        WS_MAX_RECONNECT_ATTEMPTS: 10,
        AUDIO_PRELOAD_TIMEOUT: 8000,
        AUDIO_PLAY_RETRY_DELAY: 100,
        AUDIO_PLAY_MAX_RETRIES: 30,
        TOAST_DURATION: 3000
    };

    // =========================================================================
    // VARIABLES GLOBALES
    // =========================================================================
    let ws = null;
    let wsConnected = false;
    let wsReconnectAttempts = 0;
    let wsReconnectTimer = null;

    const roomCode = '{{.Room.Code}}';
    const roomId = '{{.Room.ID}}';
    const currentUserId = '{{.User.ID}}';
    let roomStatus = '{{.Room.Status}}';
    const isHost = '{{.Player.IsHost}}' === 'true';
    let isReady = '{{.Player.IsReady}}' === 'true';

    // √âtat du jeu
    let gameState = {
        hasAnsweredCorrectly: false,
        currentRound: 0,
        totalRounds: 10,
        isRoundActive: false,
        isRevealed: false
    };

    // √âtat audio
    let audioState = {
        isPlaying: false,
        isPreloaded: false,
        preloadedUrl: null,
        currentUrl: null,
        volume: 0.8
    };

    // √âl√©ments DOM mis en cache
    let DOM = {};

    // =========================================================================
    // INITIALISATION DOM
    // =========================================================================
    function initDOM() {
        DOM = {
            // Loading
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            loadingProgress: document.getElementById('loading-progress'),
            
            // Connection
            connectionStatus: document.getElementById('connection-status'),
            connectionText: document.getElementById('connection-text'),
            
            // States
            waitingState: document.getElementById('waiting-state'),
            playingState: document.getElementById('playing-state'),
            finishedState: document.getElementById('finished-state'),
            
            // Game UI
            roundNumber: document.getElementById('round-number'),
            timer: document.getElementById('timer'),
            trackImage: document.getElementById('track-image'),
            answerForm: document.getElementById('answer-form'),
            answerInput: document.getElementById('answer-input'),
            submitAnswer: document.getElementById('submit-answer'),
            answerFeedback: document.getElementById('answer-feedback'),
            playerFoundAlerts: document.getElementById('player-found-alerts'),
            revealSection: document.getElementById('reveal-section'),
            
            // Audio
            mainAudio: document.getElementById('main-audio'),
            preloadAudio: document.getElementById('preload-audio'),
            playBtn: document.getElementById('play-btn'),
            playIcon: document.getElementById('play-icon'),
            progressBar: document.getElementById('progress-bar'),
            progressFill: document.getElementById('progress-fill'),
            volumeSlider: document.getElementById('volume-slider'),
            
            // Scoreboard
            scoreboard: document.getElementById('scoreboard'),
            scoreboardList: document.getElementById('scoreboard-list'),
            
            // Players
            playersList: document.getElementById('players-list'),
            playerCount: document.getElementById('player-count'),
            
            // Buttons
            startBtn: document.getElementById('start-btn'),
            startHint: document.getElementById('start-hint'),
            readyBtn: document.getElementById('ready-btn'),
            readyText: document.getElementById('ready-text'),
            
            // End game
            winnerName: document.getElementById('winner-name'),
            winnerScore: document.getElementById('winner-score'),
            finalScores: document.getElementById('final-scores')
        };
    }

    // =========================================================================
    // UTILITAIRES
    // =========================================================================
    function showToast(message, type = 'info', duration = CONFIG.TOAST_DURATION) {
        const container = document.getElementById('toastContainer') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
        toast.innerHTML = `
            <span class="toast-icon">${icons[type] || icons.info}</span>
            <span class="toast-message">${message}</span>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container';
        container.id = 'toastContainer';
        document.body.appendChild(container);
        return container;
    }

    function showLoading(show, text = 'Chargement...', progress = 0) {
        if (show) {
            DOM.loadingText.textContent = text;
            DOM.loadingProgress.style.width = progress + '%';
            DOM.loadingOverlay.classList.add('visible');
        } else {
            DOM.loadingOverlay.classList.remove('visible');
        }
    }

    function updateConnectionStatus(status) {
        DOM.connectionStatus.className = `connection-status ${status}`;
        const statusDot = DOM.connectionStatus.querySelector('.status-dot');
        
        switch(status) {
            case 'connected':
                DOM.connectionText.textContent = 'Connect√©';
                statusDot.classList.remove('pulsing');
                break;
            case 'disconnected':
                DOM.connectionText.textContent = 'D√©connect√©';
                statusDot.classList.add('pulsing');
                break;
            case 'connecting':
                DOM.connectionText.textContent = 'Connexion...';
                statusDot.classList.add('pulsing');
                break;
        }
    }

    // =========================================================================
    // WEBSOCKET
    // =========================================================================
    function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('[WS] D√©j√† connect√©');
            return;
        }

        updateConnectionStatus('connecting');
        
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/room/${roomCode}`;
        
        console.log('[WS] Connexion √†:', wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('[WS] ‚úÖ Connect√©');
                wsConnected = true;
                wsReconnectAttempts = 0;
                updateConnectionStatus('connected');
                showToast('Connect√© √† la salle', 'success');
            };
            
            ws.onclose = (event) => {
                console.log('[WS] Ferm√©:', event.code, event.reason);
                wsConnected = false;
                updateConnectionStatus('disconnected');
                
                if (!event.wasClean && wsReconnectAttempts < CONFIG.WS_MAX_RECONNECT_ATTEMPTS) {
                    scheduleReconnect();
                }
            };
            
            ws.onerror = (error) => {
                console.error('[WS] ‚ùå Erreur:', error);
                updateConnectionStatus('disconnected');
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWSMessage(message);
                } catch (e) {
                    console.error('[WS] Erreur parsing:', e);
                }
            };
        } catch (error) {
            console.error('[WS] Erreur cr√©ation:', error);
            scheduleReconnect();
        }
    }

    function scheduleReconnect() {
        if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
        
        wsReconnectAttempts++;
        const delay = Math.min(CONFIG.WS_RECONNECT_DELAY * wsReconnectAttempts, 10000);
        
        console.log(`[WS] Reconnexion dans ${delay}ms (tentative ${wsReconnectAttempts})`);
        updateConnectionStatus('connecting');
        
        wsReconnectTimer = setTimeout(connectWebSocket, delay);
    }

    function sendWS(type, payload = {}) {
        if (!wsConnected || !ws || ws.readyState !== WebSocket.OPEN) {
            console.warn('[WS] Non connect√©, impossible d\'envoyer:', type);
            return false;
        }
        
        const message = { type, payload };
        ws.send(JSON.stringify(message));
        console.log('[WS] üì§ Envoy√©:', type);
        return true;
    }

    function handleWSMessage(message) {
        console.log('[WS] üì® Re√ßu:', message.type, message);
        
        const handlers = {
            // Salle
            'player_ready': onPlayerReady,
            'player_joined': onPlayerJoined,
            'player_left': onPlayerLeft,
            'room_update': onRoomUpdate,
            'start_game': onGameStart,
            
            // Blind Test
            'bt_preload': onPreload,
            'bt_new_round': onNewRound,
            'time_update': onTimeUpdate,
            'bt_result': onAnswerResult,
            'player_found': onPlayerFound,
            'bt_reveal': onReveal,
            'bt_scores': onScoresUpdate,
            'bt_game_end': onGameEnd,
            
            // Erreurs
            'error': (data) => showToast(data.error || message.error || 'Erreur', 'error'),
            'pong': () => {} // Silencieux
        };
        
        const handler = handlers[message.type];
        if (handler) {
            handler(message.payload || message);
        } else {
            console.log('[WS] Message non g√©r√©:', message.type);
        }
    }

    // =========================================================================
    // GESTION AUDIO OPTIMIS√âE
    // =========================================================================
    function preloadAudio(url) {
        return new Promise((resolve, reject) => {
            if (!url) {
                reject(new Error('URL audio manquante'));
                return;
            }
            
            console.log('[Audio] üîÑ Pr√©chargement:', url.substring(0, 50) + '...');
            
            const audio = DOM.preloadAudio;
            let resolved = false;
            
            const cleanup = () => {
                audio.oncanplaythrough = null;
                audio.onerror = null;
                audio.onloadeddata = null;
            };
            
            const timeoutId = setTimeout(() => {
                if (!resolved) {
                    console.warn('[Audio] ‚è±Ô∏è Timeout pr√©chargement, on continue');
                    cleanup();
                    resolved = true;
                    resolve(false);
                }
            }, CONFIG.AUDIO_PRELOAD_TIMEOUT);
            
            audio.oncanplaythrough = () => {
                if (!resolved) {
                    clearTimeout(timeoutId);
                    cleanup();
                    console.log('[Audio] ‚úÖ Pr√©charg√© avec succ√®s');
                    audioState.isPreloaded = true;
                    audioState.preloadedUrl = url;
                    resolved = true;
                    resolve(true);
                }
            };
            
            audio.onloadeddata = () => {
                // Le fichier est charg√©, on peut commencer √† jouer m√™me si pas enti√®rement buffered
                if (!resolved && audio.readyState >= 2) {
                    clearTimeout(timeoutId);
                    cleanup();
                    console.log('[Audio] ‚úÖ Donn√©es charg√©es');
                    audioState.isPreloaded = true;
                    audioState.preloadedUrl = url;
                    resolved = true;
                    resolve(true);
                }
            };
            
            audio.onerror = (e) => {
                if (!resolved) {
                    clearTimeout(timeoutId);
                    cleanup();
                    console.error('[Audio] ‚ùå Erreur pr√©chargement:', e);
                    resolved = true;
                    resolve(false);
                }
            };
            
            // Charger
            audio.src = url;
            audio.load();
        });
    }

    async function playAudio(url) {
        const audio = DOM.mainAudio;
        
        // Si c'est le m√™me URL pr√©charg√©, copier depuis preload
        if (audioState.preloadedUrl === url && audioState.isPreloaded) {
            console.log('[Audio] üéµ Utilisation audio pr√©charg√©');
            audio.src = url;
        } else {
            console.log('[Audio] üéµ Chargement direct');
            audio.src = url;
        }
        
        audioState.currentUrl = url;
        audio.volume = audioState.volume;
        
        // Tenter de jouer avec retries
        let retries = 0;
        const tryPlay = async () => {
            try {
                await audio.play();
                audioState.isPlaying = true;
                updatePlayButton(true);
                console.log('[Audio] ‚ñ∂Ô∏è Lecture d√©marr√©e');
                return true;
            } catch (e) {
                if (e.name === 'NotAllowedError') {
                    console.log('[Audio] Autoplay bloqu√©, clic utilisateur requis');
                    showToast('Cliquez sur ‚ñ∂Ô∏è pour √©couter', 'info');
                    return false;
                } else if (retries < CONFIG.AUDIO_PLAY_MAX_RETRIES) {
                    retries++;
                    await new Promise(r => setTimeout(r, CONFIG.AUDIO_PLAY_RETRY_DELAY));
                    return tryPlay();
                } else {
                    console.error('[Audio] ‚ùå Impossible de jouer:', e);
                    showToast('Erreur audio, cliquez sur ‚ñ∂Ô∏è', 'warning');
                    return false;
                }
            }
        };
        
        return tryPlay();
    }

    function stopAudio() {
        const audio = DOM.mainAudio;
        audio.pause();
        audio.currentTime = 0;
        audioState.isPlaying = false;
        updatePlayButton(false);
    }

    function togglePlay() {
        const audio = DOM.mainAudio;
        
        if (audioState.isPlaying) {
            audio.pause();
            audioState.isPlaying = false;
            updatePlayButton(false);
        } else {
            audio.play().then(() => {
                audioState.isPlaying = true;
                updatePlayButton(true);
            }).catch(e => {
                console.error('[Audio] Erreur play:', e);
                showToast('Impossible de lire l\'audio', 'error');
            });
        }
    }

    function updatePlayButton(playing) {
        if (DOM.playIcon) {
            DOM.playIcon.className = playing ? 'icon icon-pause icon-md' : 'icon icon-play icon-md';
        }
    }

    function setVolume(value) {
        audioState.volume = value / 100;
        DOM.mainAudio.volume = audioState.volume;
    }

    function seekAudio(event) {
        const rect = DOM.progressBar.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        DOM.mainAudio.currentTime = percent * DOM.mainAudio.duration;
    }

    function updateAudioProgress() {
        if (DOM.mainAudio.duration) {
            const percent = (DOM.mainAudio.currentTime / DOM.mainAudio.duration) * 100;
            DOM.progressFill.style.width = percent + '%';
        }
    }

    // =========================================================================
    // HANDLERS WEBSOCKET
    // =========================================================================
    function onRoomUpdate(data) {
        if (data.status) {
            roomStatus = data.status;
        }
        if (data.is_ready !== undefined) {
            updateStartButton();
        }
    }

    function onPlayerReady(data) {
        const playerItem = document.querySelector(`[data-user-id="${data.user_id}"]`);
        if (playerItem) {
            const statusEl = playerItem.querySelector('.player-status span');
            const readyIcon = playerItem.querySelector('.player-ready-icon');
            
            if (data.ready) {
                if (statusEl) {
                    statusEl.className = 'text-success';
                    statusEl.textContent = 'Pr√™t';
                }
                if (readyIcon) {
                    readyIcon.className = 'player-ready-icon ready';
                    readyIcon.innerHTML = '<span class="icon icon-check icon-sm"></span>';
                }
            } else {
                if (statusEl) {
                    statusEl.className = 'text-muted';
                    statusEl.textContent = 'En attente';
                }
                if (readyIcon) {
                    readyIcon.className = 'player-ready-icon not-ready';
                    readyIcon.innerHTML = '<span class="icon icon-timer icon-sm"></span>';
                }
            }
        }
        updateStartButton();
    }

    function onPlayerJoined(data) {
        showToast(`${data.pseudo} a rejoint la salle`, 'info');
        addPlayerToUI(data);
    }

    function onPlayerLeft(data) {
        showToast(`${data.pseudo} a quitt√© la salle`, 'warning');
        removePlayerFromUI(data.user_id);
    }

    function onGameStart(data) {
        console.log('[Game] üéÆ Partie d√©marr√©e:', data);
        showToast('La partie commence !', 'success');
        roomStatus = 'playing';
        
        DOM.waitingState.classList.add('hidden');
        DOM.playingState.classList.remove('hidden');
        DOM.scoreboard.classList.remove('hidden');
        
        gameState.totalRounds = data.rounds || 10;
        gameState.currentRound = 0;
        gameState.hasAnsweredCorrectly = false;
    }

    async function onPreload(data) {
        console.log('[Game] üîÑ Pr√©chargement manche', data.round);
        showLoading(true, `Pr√©paration manche ${data.round}...`, 20);
        
        const success = await preloadAudio(data.preview_url);
        
        showLoading(true, `Pr√©paration manche ${data.round}...`, success ? 100 : 50);
        
        // Le round va arriver juste apr√®s
    }

    async function onNewRound(data) {
        console.log('[Game] üéµ Nouvelle manche:', data);
        
        // √âviter les doubles ex√©cutions
        if (gameState.isRoundActive && gameState.currentRound === data.round) {
            console.warn('[Game] ‚ö†Ô∏è Round d√©j√† actif');
            return;
        }
        
        gameState.isRoundActive = true;
        gameState.currentRound = data.round;
        gameState.hasAnsweredCorrectly = false;
        gameState.isRevealed = false;
        
        // Mise √† jour UI
        DOM.roundNumber.textContent = `Manche ${data.round}/${data.total}`;
        DOM.timer.textContent = data.duration + 's';
        DOM.timer.className = '';
        
        // R√©initialiser le formulaire
        DOM.answerForm.classList.remove('disabled');
        DOM.answerInput.disabled = false;
        DOM.answerInput.value = '';
        DOM.submitAnswer.disabled = false;
        
        // Cacher les sections de feedback
        DOM.answerFeedback.classList.add('hidden');
        DOM.playerFoundAlerts.innerHTML = '';
        DOM.revealSection.classList.add('hidden');
        
        // Image floue
        DOM.trackImage.classList.add('blur');
        DOM.trackImage.classList.remove('revealed');
        DOM.trackImage.src = '/static/img/album-placeholder.png';
        
        // Cacher le loading
        showLoading(false);
        
        // Jouer l'audio
        await playAudio(data.preview_url);
        
        // Reset pr√©chargement
        audioState.isPreloaded = false;
        audioState.preloadedUrl = null;
        
        // Focus sur le champ de r√©ponse
        DOM.answerInput.focus();
    }

    function onTimeUpdate(data) {
        DOM.timer.textContent = data.time_left + 's';
        
        if (data.time_left <= 5) {
            DOM.timer.className = 'danger';
        } else if (data.time_left <= 10) {
            DOM.timer.className = 'warning';
        } else {
            DOM.timer.className = '';
        }
    }

    function onAnswerResult(data) {
        DOM.answerFeedback.classList.remove('hidden');
        
        if (data.already_answered) {
            DOM.answerFeedback.className = 'answer-feedback wrong';
            DOM.answerFeedback.textContent = 'Vous avez d√©j√† trouv√© !';
        } else if (data.is_correct) {
            DOM.answerFeedback.className = 'answer-feedback correct';
            DOM.answerFeedback.textContent = `‚úì Bonne r√©ponse ! +${data.points} points`;
            gameState.hasAnsweredCorrectly = true;
            
            // D√©sactiver le formulaire
            DOM.answerForm.classList.add('disabled');
            DOM.answerInput.disabled = true;
            DOM.submitAnswer.disabled = true;
        } else {
            DOM.answerFeedback.className = 'answer-feedback wrong';
            DOM.answerFeedback.textContent = '‚úï Mauvaise r√©ponse, r√©essayez !';
            
            // Permettre de r√©essayer
            DOM.answerInput.value = '';
            DOM.answerInput.focus();
        }
    }

    function onPlayerFound(data) {
        const alert = document.createElement('div');
        alert.className = 'player-found-alert';
        alert.innerHTML = `üéâ <strong>${data.pseudo}</strong> a trouv√© ! (+${data.points} pts)`;
        DOM.playerFoundAlerts.appendChild(alert);
        
        // Supprimer apr√®s 3 secondes
        setTimeout(() => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }

    function onReveal(data) {
        console.log('[Game] üîì R√©v√©lation:', data);
        
        gameState.isRoundActive = false;
        gameState.isRevealed = true;
        
        // Arr√™ter l'audio
        stopAudio();
        
        // Afficher la r√©ponse
        DOM.revealSection.innerHTML = `
            <div class="reveal-card">
                <img src="${data.image_url || '/static/img/album-placeholder.png'}" alt="Album">
                <h3>${data.track_name}</h3>
                <p>${data.artist_name}</p>
                <p class="text-muted">${data.album_name}</p>
            </div>
        `;
        DOM.revealSection.classList.remove('hidden');
        
        // R√©v√©ler l'image
        if (data.image_url) {
            DOM.trackImage.src = data.image_url;
        }
        DOM.trackImage.classList.remove('blur');
        DOM.trackImage.classList.add('revealed');
        
        // D√©sactiver le formulaire
        DOM.answerForm.classList.add('disabled');
        DOM.answerInput.disabled = true;
        DOM.submitAnswer.disabled = true;
    }

    function onScoresUpdate(scores) {
        DOM.scoreboardList.innerHTML = '';
        
        if (!Array.isArray(scores)) {
            scores = Object.values(scores);
        }
        
        scores.forEach((score, index) => {
            const row = document.createElement('div');
            row.className = 'score-row';
            row.innerHTML = `
                <span class="score-rank">${index + 1}.</span>
                <span class="score-player">${score.pseudo}</span>
                <span class="score-value">${score.score} pts</span>
            `;
            DOM.scoreboardList.appendChild(row);
        });
    }

    function onGameEnd(data) {
        console.log('[Game] üèÅ Fin de partie:', data);
        roomStatus = 'finished';
        gameState.isRoundActive = false;
        
        stopAudio();
        
        DOM.playingState.classList.add('hidden');
        DOM.finishedState.classList.remove('hidden');
        
        // Afficher le gagnant
        DOM.winnerName.textContent = data.winner || 'Personne';
        
        if (data.scores && data.scores.length > 0) {
            DOM.winnerScore.textContent = `${data.scores[0].score} points`;
            
            // Classement final
            DOM.finalScores.innerHTML = '';
            data.scores.forEach((score, index) => {
                const row = document.createElement('div');
                row.className = 'score-row';
                row.innerHTML = `
                    <span class="score-rank">${index + 1}.</span>
                    <span class="score-player">${score.pseudo}</span>
                    <span class="score-value">${score.score} pts</span>
                `;
                DOM.finalScores.appendChild(row);
            });
        }
        
        showToast('Partie termin√©e !', 'success', 5000);
    }

    // =========================================================================
    // ACTIONS UTILISATEUR
    // =========================================================================
    function copyRoomCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            showToast('Code copi√© !', 'success');
        }).catch(() => {
            showToast('Erreur lors de la copie', 'error');
        });
    }

    function toggleReady() {
        isReady = !isReady;
        sendWS('player_ready', { ready: isReady });
        
        if (DOM.readyBtn) {
            if (isReady) {
                DOM.readyBtn.classList.remove('btn-primary');
                DOM.readyBtn.classList.add('btn-warning');
                DOM.readyText.textContent = 'Annuler';
            } else {
                DOM.readyBtn.classList.remove('btn-warning');
                DOM.readyBtn.classList.add('btn-primary');
                DOM.readyText.textContent = 'Je suis pr√™t !';
            }
        }
    }

    function startGame() {
        if (!isHost) {
            showToast('Seul l\'h√¥te peut lancer la partie', 'warning');
            return;
        }
        sendWS('start_game', {});
    }

    function submitAnswer() {
        if (gameState.hasAnsweredCorrectly) {
            showToast('Vous avez d√©j√† trouv√© !', 'info');
            return;
        }
        
        const answer = DOM.answerInput.value.trim();
        
        if (!answer) {
            showToast('Entrez une r√©ponse', 'warning');
            return;
        }

        sendWS('bt_answer', { answer });
    }

    function leaveRoom() {
        if (confirm('Voulez-vous vraiment quitter la salle ?')) {
            sendWS('leave_room', {});
            window.location.href = '/rooms';
        }
    }

    function restartGame() {
        fetch(`/api/rooms/${roomCode}/restart`, {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Partie relanc√©e !', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(data.message || 'Erreur', 'error');
            }
        })
        .catch(() => {
            showToast('Erreur de connexion', 'error');
        });
    }

    function updateStartButton() {
        if (!DOM.startBtn) return;

        const playerItems = document.querySelectorAll('.player-item');
        const playerCount = playerItems.length;
        let nonHostNotReady = 0;

        playerItems.forEach(item => {
            if (!item.classList.contains('is-host')) {
                const readyIcon = item.querySelector('.player-ready-icon');
                if (readyIcon && readyIcon.classList.contains('not-ready')) {
                    nonHostNotReady++;
                }
            }
        });

        // Permettre le mode solo OU tous pr√™ts
        const canStart = (playerCount === 1) || (nonHostNotReady === 0);
        
        DOM.startBtn.disabled = !canStart;
        
        if (DOM.startHint) {
            if (playerCount === 1) {
                DOM.startHint.textContent = 'Mode solo disponible - Lancez quand vous voulez !';
            } else if (canStart) {
                DOM.startHint.textContent = 'Tous les joueurs sont pr√™ts !';
            } else {
                DOM.startHint.textContent = `En attente de ${nonHostNotReady} joueur(s)...`;
            }
        }
    }

    function addPlayerToUI(player) {
        if (!DOM.playersList) return;
        
        if (document.querySelector(`[data-user-id="${player.user_id}"]`)) return;
        
        const div = document.createElement('div');
        div.className = 'player-item';
        div.dataset.userId = player.user_id;
        div.innerHTML = `
            <div class="player-avatar">${player.pseudo.charAt(0)}</div>
            <div class="player-info">
                <div class="player-name">${player.pseudo}</div>
                <div class="player-status"><span class="text-muted">En attente</span></div>
            </div>
            <div class="player-ready-icon not-ready">
                <span class="icon icon-timer icon-sm"></span>
            </div>
        `;
        DOM.playersList.appendChild(div);
        
        DOM.playerCount.textContent = DOM.playersList.children.length;
        updateStartButton();
    }

    function removePlayerFromUI(userId) {
        const el = document.querySelector(`[data-user-id="${userId}"]`);
        if (el) el.remove();
        
        DOM.playerCount.textContent = DOM.playersList.children.length;
        updateStartButton();
    }

    // =========================================================================
    // INITIALISATION
    // =========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('[Init] üéÆ D√©marrage - Salle:', roomCode, 'Status:', roomStatus);
        
        // Initialiser le cache DOM
        initDOM();
        
        // Configurer l'audio
        DOM.mainAudio.addEventListener('timeupdate', updateAudioProgress);
        DOM.mainAudio.addEventListener('ended', () => {
            audioState.isPlaying = false;
            updatePlayButton(false);
        });
        DOM.mainAudio.volume = audioState.volume;
        DOM.volumeSlider.value = audioState.volume * 100;
        
        // Afficher le bon √©tat initial
        if (roomStatus === 'playing') {
            DOM.waitingState.classList.add('hidden');
            DOM.playingState.classList.remove('hidden');
            DOM.scoreboard.classList.remove('hidden');
        } else if (roomStatus === 'finished') {
            DOM.waitingState.classList.add('hidden');
            DOM.finishedState.classList.remove('hidden');
        }
        
        // Connexion WebSocket
        connectWebSocket();
        
        // Mettre √† jour le bouton start
        updateStartButton();
        
        // Gestionnaire touche Entr√©e
        if (DOM.answerInput) {
            DOM.answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitAnswer();
                }
            });
        }
        
        // Ping p√©riodique pour maintenir la connexion
        setInterval(() => {
            if (wsConnected) {
                sendWS('ping', {});
            }
        }, 30000);
    });

    // G√©rer la fermeture de page
    window.addEventListener('beforeunload', () => {
        if (ws) {
            ws.close(1000, 'Page ferm√©e');
        }
    });
    </script>
</body>
</html>